<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超級摘要小幫手 (HTML版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 引入 html2canvas 用於截圖 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* 自定義樣式 */
        .deletion-text {
            color: #dc2626; /* red-600 */
            font-weight: bold;
            cursor: pointer;
        }
        .deletion-text:hover {
            color: #b91c1c; /* red-700 */
        }
        [contenteditable]:focus {
            outline: none;
        }
        /* 螢光筆樣式 */
        .highlight-text {
            background-color: #fef08a; /* 亮黃色 */
            padding: 2px 0;
            border-radius: 2px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .highlight-text:hover {
            background-color: #fde047; /* 滑鼠移過去變深 */
        }
    </style>
</head>
<body class="bg-slate-50 font-sans pb-32">

    <!-- 頂部導航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-indigo-100">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                    <i data-lucide="book-open"></i>
                </div>
                <h1 class="text-2xl font-bold text-indigo-900">超級摘要小幫手</h1>
            </div>
            <button onclick="toggleTeacherModal()" class="text-gray-300 hover:text-indigo-600 p-2 transition-colors">
                <i data-lucide="user"></i>
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
        
        <!-- 理解監控三階段 -->
        <section class="bg-white/80 backdrop-blur-sm rounded-3xl p-6 shadow-lg border border-indigo-50">
            <div class="flex items-center gap-3 mb-8 pb-2 border-b border-gray-100">
                <span class="text-3xl bg-indigo-100 p-2 rounded-lg">🧠</span>
                <h2 class="text-2xl font-bold text-indigo-800">理解監控三階段</h2>
                <span class="text-sm text-gray-500 ml-auto">跟著步驟做，摘要變簡單！</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Stage 1 -->
                <div class="group relative overflow-hidden bg-white rounded-2xl border-2 border-blue-100 shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-cyan-300"></div>
                    <div class="p-5 flex items-center gap-3 bg-blue-50/50 border-b border-blue-100">
                        <div class="bg-white p-2 rounded-lg shadow-sm text-blue-600"><i data-lucide="book-open"></i></div>
                        <h3 class="text-xl font-bold text-blue-800">閱讀前</h3>
                        <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full font-bold ml-auto">設定摘要目標</span>
                    </div>
                    <div class="p-5 flex-grow space-y-4">
                        <p class="text-gray-500 font-bold mb-4 text-sm uppercase tracking-wide">我要做到：</p>
                        <div class="flex items-start gap-3"><span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0 shadow-md">1</span><span class="text-gray-700 font-medium pt-0.5">我要找出每段最重要的內容</span></div>
                        <div class="flex items-start gap-3"><span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0 shadow-md">2</span><span class="text-gray-700 font-medium pt-0.5">我要刪掉不重要或多餘的細節</span></div>
                        <div class="flex items-start gap-3"><span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0 shadow-md">3</span><span class="text-gray-700 font-medium pt-0.5">我要把句子排得順一點</span></div>
                    </div>
                </div>
                <!-- Stage 2 -->
                <div class="group relative overflow-hidden bg-white rounded-2xl border-2 border-yellow-100 shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-400 to-orange-300"></div>
                    <div class="p-5 flex items-center gap-3 bg-yellow-50/50 border-b border-yellow-100">
                        <div class="bg-white p-2 rounded-lg shadow-sm text-yellow-600"><i data-lucide="search"></i></div>
                        <h3 class="text-xl font-bold text-yellow-800">閱讀中</h3>
                        <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full font-bold ml-auto">邊讀邊想</span>
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <p class="text-gray-500 font-bold mb-4 text-sm uppercase tracking-wide">自我提問與測驗：</p>
                        <div class="space-y-3 mb-4">
                            <button onclick="showHint('q1')" class="w-full bg-white p-3 rounded-xl border-2 border-yellow-100 text-gray-700 shadow-sm text-left font-bold hover:bg-yellow-50 transition-all flex justify-between items-center">
                                <span>🤔 我真的懂這段在說什麼嗎？</span>
                            </button>
                            <button onclick="showHint('q2')" class="w-full bg-white p-3 rounded-xl border-2 border-yellow-100 text-gray-700 shadow-sm text-left font-bold hover:bg-yellow-50 transition-all flex justify-between items-center">
                                <span>🎯 這段的重點是什麼？</span>
                            </button>
                            <button onclick="showHint('q3')" class="w-full bg-white p-3 rounded-xl border-2 border-yellow-100 text-gray-700 shadow-sm text-left font-bold hover:bg-yellow-50 transition-all flex justify-between items-center">
                                <span>✂️ 有哪些細節可以刪掉？</span>
                            </button>
                        </div>
                        <div id="hint-display" class="relative bg-yellow-100/50 p-4 rounded-xl border border-yellow-200 text-yellow-900 text-sm font-bold text-center shadow-inner mb-4">
                            點擊上方按鈕進行理解檢查...
                        </div>
                    </div>
                </div>
                <!-- Stage 3 -->
                <div class="group relative overflow-hidden bg-white rounded-2xl border-2 border-green-100 shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-emerald-300"></div>
                    <div class="p-5 flex items-center gap-3 bg-green-50/50 border-b border-green-100">
                        <div class="bg-white p-2 rounded-lg shadow-sm text-green-600"><i data-lucide="clipboard-list"></i></div>
                        <h3 class="text-xl font-bold text-green-800">閱讀後</h3>
                        <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full font-bold ml-auto">自我檢查</span>
                    </div>
                    <div class="p-5 flex-grow">
                        <p class="text-gray-500 font-bold mb-4 text-sm uppercase tracking-wide">完成後問自己：</p>
                        <ul class="space-y-4 text-gray-700 font-medium">
                            <li class="flex gap-3"><i data-lucide="check-circle" class="text-green-500 w-5 h-5 shrink-0"></i> 我寫的摘要有把重點說清楚嗎？</li>
                            <li class="flex gap-3"><i data-lucide="check-circle" class="text-green-500 w-5 h-5 shrink-0"></i> 還有哪裡看不懂或不太確定嗎？</li>
                            <li class="flex gap-3"><i data-lucide="check-circle" class="text-green-500 w-5 h-5 shrink-0"></i> 刪掉的都是不重要的嗎？</li>
                            <li class="flex gap-3"><i data-lucide="check-circle" class="text-green-500 w-5 h-5 shrink-0"></i> 句子讀起來通順嗎？</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- 作業區 (可截圖範圍) -->
        <section id="workspace-card" class="bg-white rounded-2xl border-2 border-blue-200 shadow-lg overflow-hidden">
            <!-- 標頭 -->
            <div class="bg-blue-50/50 p-4 border-b border-blue-100">
                <div class="text-center mb-4 relative">
                    <h2 class="text-2xl font-bold text-blue-900 flex items-center justify-center gap-2">
                        <i data-lucide="camera" class="text-gray-600"></i> 學生作業截圖
                    </h2>
                    <button onclick="handleDownloadSnapshot()" id="btn-snapshot" class="absolute right-0 top-1/2 -translate-y-1/2 bg-white text-blue-600 border border-blue-200 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 hover:bg-blue-50 transition-colors shadow-sm">
                        <i data-lucide="download" class="w-4 h-4"></i> 下載截圖
                    </button>
                </div>
                <div class="flex justify-between items-center px-2">
                    <div class="flex items-center gap-2 text-lg font-bold text-gray-700">
                        <i data-lucide="user" class="text-purple-700"></i>
                        <span id="display-student-name">學生姓名 (座號: ?)</span>
                    </div>
                    <div class="flex items-center gap-2 text-lg font-bold">
                        <span class="text-orange-500 text-2xl">💪</span>
                        <span id="display-confidence" class="text-purple-700">尚未評估</span>
                    </div>
                </div>
            </div>

            <!-- 統計列 -->
            <div class="bg-purple-50 px-6 py-3 flex flex-wrap gap-6 items-center text-sm md:text-base justify-between border-b border-purple-100">
                <div class="flex items-center gap-2 font-bold text-purple-700">
                    <i data-lucide="bar-chart-2" class="text-green-600"></i> 摘要統計
                </div>
                <div class="flex gap-4 font-bold text-gray-600">
                    <div>總字數: <span id="stat-original" class="text-blue-600">0</span></div>
                    <div>刪除: <span id="stat-deleted" class="text-red-500">0</span></div>
                    <div>保留: <span id="stat-kept" class="text-green-600">0</span></div>
                    <div>比例: <span id="stat-ratio" class="text-blue-600">100%</span></div>
                    <div>刪除片段: <span id="stat-fragments" class="text-purple-500">0</span></div>
                </div>
            </div>

            <!-- 快速輸入工具 (截圖時隱藏) -->
            <div id="quick-toolbar" class="bg-white p-3 border-b-2 border-indigo-100 flex flex-wrap items-center gap-4 justify-center">
                <div class="flex items-center gap-2 text-indigo-700 font-bold shrink-0">
                    <i data-lucide="rocket"></i> 快速輸入工具
                </div>
                <div class="flex flex-wrap items-center gap-x-4 gap-y-2" id="toolbar-buttons">
                    <!-- Buttons generated by JS -->
                </div>
            </div>

            <!-- 主要操作區 (Grid) -->
<div id="workspace-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-0 divide-x-2 divide-gray-100">
                <div class="flex flex-col bg-yellow-50/20">
                    <div class="p-3 bg-yellow-50 border-b-2 border-yellow-100">
                        <div class="flex flex-wrap items-center justify-between gap-y-2">
                            <h4 class="font-bold text-gray-700 flex items-center gap-2 shrink-0">
                                📖 刪除過程 <span class="text-xs font-normal text-red-600 bg-white px-2 py-0.5 rounded-full border border-red-100 hidden sm:inline-block">紅字+粗體=刪除</span>
                            </h4>
                            <div class="flex flex-wrap gap-2 items-center">
                                <button onclick="handleDeleteSelection()" class="shrink-0 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs flex items-center gap-1 font-bold shadow-sm transition-all"><i data-lucide="scissors" class="w-3 h-3"></i> 刪除/復原</button>
                                <button onclick="handleHighlightSelection()" class="shrink-0 bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded-lg text-xs flex items-center gap-1 font-bold shadow-sm transition-all text-shadow"><i data-lucide="highlighter" class="w-3 h-3"></i> 畫重點</button>
                                <button onclick="toggleArticleModal()" class="shrink-0 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs flex items-center gap-1 font-bold shadow-sm transition-all"><i data-lucide="library" class="w-3 h-3"></i> 選文章</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="deletion-area" class="p-6 flex-grow text-lg leading-loose text-gray-800 whitespace-pre-wrap outline-none min-h-[450px]" style="line-height: 2.5rem;" contenteditable="true"></div>
                    
                    <div id="ai-hint-section" class="p-3 bg-yellow-50 border-t-2 border-yellow-100 min-h-[80px] flex flex-col justify-center items-center">
                        <button id="btn-ask-hint" onclick="askAIHint()" class="w-full bg-white border-2 border-yellow-200 text-yellow-700 py-2 rounded-xl flex items-center justify-center gap-2 hover:bg-yellow-50 transition-colors font-bold shadow-sm active:scale-95">
                            <i data-lucide="lightbulb"></i> 🔑 找不到重點？問問 AI 小偵探
                        </button>
                        <div id="ai-hint-content" class="hidden w-full relative">
                            <button onclick="closeAIHint()" class="absolute top-1 right-1 text-gray-400 hover:text-gray-600 z-10"><i data-lucide="x" class="w-4 h-4"></i></button>
                            <div class="p-4 bg-white rounded-2xl border-2 border-yellow-200 shadow-md">
                                <div class="flex items-center gap-2 mb-2 text-yellow-800 font-bold border-b border-yellow-100 pb-2">
                                    <i data-lucide="sparkles" class="text-yellow-500"></i> AI 小偵探的提示：
                                </div>
                                <div id="ai-hint-text" class="text-lg leading-relaxed text-gray-700 whitespace-pre-wrap"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col bg-green-50/20">
                    <div class="p-3 bg-green-50 border-b-2 border-green-100 flex justify-between items-center h-[60px] md:h-auto">
                        <h4 class="font-bold text-green-800 flex items-center gap-2">✨ 完成的摘要 <span class="text-xs font-normal text-green-600 bg-white px-2 py-0.5 rounded-full border border-green-100 hidden sm:inline-block">可直接編輯</span></h4>
                        <div class="text-xs text-indigo-400 flex items-center gap-1"><i data-lucide="rocket" class="w-3 h-3"></i> 上方可快速輸入</div>
                    </div>
                    <div id="summary-area" class="p-6 flex-grow text-lg leading-loose text-gray-800 whitespace-pre-wrap outline-none min-h-[450px]" style="line-height: 2.5rem;" contenteditable="true"></div>

                    <div id="ai-feedback-section" class="p-3 bg-green-50 border-t-2 border-green-100 min-h-[80px] flex flex-col justify-center items-center">
                        <button id="btn-ask-feedback" onclick="askAIFeedback()" class="w-full bg-white border-2 border-green-200 text-green-700 py-2 rounded-xl flex items-center justify-center gap-2 hover:bg-green-50 transition-colors font-bold shadow-sm active:scale-95">
                            <i data-lucide="message-circle"></i> 👩‍🏫 寫好了？請 AI 老師看一下
                        </button>
                        <div id="ai-feedback-content" class="hidden w-full relative">
                            <button onclick="closeAIFeedback()" class="absolute top-1 right-1 text-gray-400 hover:text-gray-600 z-10"><i data-lucide="x" class="w-4 h-4"></i></button>
                            <div class="p-4 bg-white rounded-2xl border-2 border-green-200 shadow-md">
                                <div class="flex items-center gap-2 mb-2 text-green-800 font-bold border-b border-green-100 pb-2">
                                    <i data-lucide="sparkles" class="text-green-500"></i> AI 老師的小評語：
                                </div>
                                <div id="ai-feedback-text" class="text-lg leading-relaxed text-gray-700 whitespace-pre-wrap"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 自我檢核與提交 -->
        <section class="bg-white rounded-3xl p-8 shadow-sm border border-indigo-50">
            <div class="flex items-center gap-3 mb-8">
                <span class="text-3xl bg-indigo-100 p-2 rounded-xl">🔍</span>
                <h2 class="text-2xl font-bold text-indigo-900">提交前自我檢核</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="grid grid-cols-1 gap-4" id="checklist-container">
                    <!-- Checkboxes rendered by JS -->
                </div>

                <div class="flex flex-col gap-6">
                    <div class="bg-indigo-50 p-6 rounded-3xl border-2 border-indigo-100 shadow-sm">
                        <h3 class="text-xl font-bold text-indigo-800 mb-4 flex items-center gap-2"><i data-lucide="user"></i> 學生資訊</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-indigo-600 text-sm font-bold mb-1 ml-1">你的名字</label>
                                <input type="text" id="input-name" class="w-full p-4 rounded-xl border-2 border-indigo-200 focus:border-indigo-500 outline-none text-lg bg-white" placeholder="輸入姓名" oninput="updateStudentInfo()">
                            </div>
                            <div>
                                <label class="block text-indigo-600 text-sm font-bold mb-1 ml-1">你的座號</label>
                                <input type="text" id="input-seat" class="w-full p-4 rounded-xl border-2 border-indigo-200 focus:border-indigo-500 outline-none text-lg bg-white" placeholder="輸入座號" oninput="updateStudentInfo()">
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-6 rounded-3xl border-2 border-yellow-200 flex-grow shadow-sm flex flex-col justify-center">
                        <h3 class="text-xl font-bold text-yellow-800 mb-4 flex items-center gap-2"><i data-lucide="thumbs-up"></i> 信心評估</h3>
                        <p class="font-bold text-yellow-700 mb-4 text-lg">完成這次練習，你覺得自己表現得如何？</p>
                        <div class="grid grid-cols-3 gap-3 h-full" id="confidence-container">
                            <!-- Buttons rendered by JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-12 flex justify-center">
                <button onclick="handleSubmit()" class="group relative bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-2xl font-bold py-5 px-20 rounded-full shadow-xl hover:shadow-2xl hover:scale-105 transform transition-all flex items-center gap-4 overflow-hidden">
                    <div class="absolute inset-0 bg-white/20 group-hover:translate-x-full transition-transform duration-700 skew-x-12 -translate-x-full"></div>
                    <i data-lucide="save" class="w-8 h-8"></i>
                    <span>提交作業</span>
                </button>
            </div>
        </section>
    </main>

    <!-- Article Modal -->
    <div id="article-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div class="flex items-center gap-3"><span class="bg-indigo-100 text-indigo-700 p-2 rounded-lg"><i data-lucide="library"></i></span><h3 class="text-2xl font-bold text-gray-800">選擇練習文章</h3></div>
                <button onclick="toggleArticleModal()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto space-y-4 px-2" id="article-list">
                <!-- Articles rendered by JS -->
            </div>
        </div>
    </div>

    <!-- Teacher Modal -->
    <div id="teacher-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="user"></i> 教師專區</h3>
                <button onclick="toggleTeacherModal()" class="text-gray-500 hover:text-gray-800">✕</button>
            </div>
            <div id="teacher-login" class="flex flex-col items-center justify-center py-10">
                <p class="mb-4 text-gray-600 font-bold">請輸入教師密碼 (預設: 1234)</p>
                <input type="password" id="teacher-password" class="border-2 border-gray-300 p-3 rounded-xl mb-4 w-48 text-center text-xl outline-none focus:border-indigo-500" />
                <button onclick="teacherLogin()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors">登入</button>
            </div>
            <div id="teacher-dashboard" class="hidden flex-col h-full overflow-hidden">
                <!-- Tabs -->
                <div class="flex gap-4 mb-4 border-b items-center justify-between">
                    <div class="flex gap-4">
                        <button onclick="switchTeacherTab('submissions')" id="tab-submissions" class="pb-2 px-4 font-bold text-lg transition-colors border-b-2 text-indigo-600 border-indigo-600">學生作業</button>
                        <button onclick="switchTeacherTab('articles')" id="tab-articles" class="pb-2 px-4 font-bold text-lg transition-colors border-b-2 text-gray-400 border-transparent hover:text-gray-600">文章管理</button>
                    </div>
                    <div id="sort-controls" class="flex items-center gap-2 text-sm text-gray-600 bg-gray-100 px-3 py-1.5 rounded-lg">
                        <i data-lucide="arrow-up-down" class="w-4 h-4"></i>
                        <span class="font-bold">排序：</span>
                        <select id="sort-select" onchange="renderSubmissions()" class="bg-transparent outline-none font-bold text-indigo-700 cursor-pointer">
                            <option value="time">提交時間 (新→舊)</option>
                            <option value="seat">座號 (小→大)</option>
                        </select>
                    </div>
                </div>
                <!-- Submissions View -->
                <div id="view-submissions" class="flex-col h-full overflow-hidden flex">
                    <div class="mb-4 flex gap-2">
                        <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-700 shadow-sm"><i data-lucide="download" class="w-4 h-4"></i> 匯出 CSV</button>
                        <div class="text-sm text-gray-500 self-center ml-auto bg-gray-100 px-3 py-1 rounded-full">共 <span id="submission-count">0</span> 筆資料</div>
                    </div>
                    <div class="flex-grow overflow-auto border rounded-xl bg-gray-50">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-100 sticky top-0 shadow-sm">
                                <tr>
                                    <th class="p-3 text-gray-600">時間</th>
                                    <th class="p-3 text-gray-600">姓名</th>
                                    <th class="p-3 text-gray-600">座號</th>
                                    <th class="p-3 text-gray-600">字數 (原/摘)</th>
                                    <th class="p-3 text-gray-600 bg-blue-50 text-blue-700 font-bold border-l border-blue-100">保留比例</th>
                                    <th class="p-3 text-gray-600 bg-red-50 text-red-700 font-bold border-l border-red-100">刪除片段</th>
                                    <th class="p-3 text-gray-600">自我信心</th>
                                </tr>
                            </thead>
                            <tbody id="submissions-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Articles View -->
                <div id="view-articles" class="hidden flex-col h-full gap-4">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                        <h4 class="font-bold text-indigo-800 mb-3 flex items-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i> 新增練習文章</h4>
                        <div class="flex flex-col gap-3">
                            <input type="text" id="new-article-title" placeholder="文章標題" class="p-2 rounded-lg border border-indigo-200 focus:border-indigo-500 outline-none" />
                            <textarea id="new-article-content" placeholder="貼上文章內容..." class="p-2 rounded-lg border border-indigo-200 focus:border-indigo-500 outline-none h-24 resize-none"></textarea>
                            <button onclick="addArticle()" class="bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition-colors self-end px-6">新增文章</button>
                        </div>
                    </div>
                    <div class="flex-grow overflow-auto border rounded-xl bg-white">
                        <div class="bg-gray-100 p-3 font-bold text-gray-600 sticky top-0 border-b">已建立的文章庫</div>
                        <div id="articles-manage-list" class="divide-y"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
<script>
    // 這裡填入從 Firebase Console 取得的 Web App 設定
    var __firebase_config = JSON.stringify({
        apiKey: "AIzaSyDnpeXA16Lig0yhcvuAxRk5o1MiS6yKikE",
        authDomain: "super-helper-58525.firebaseapp.com",
        projectId: "super-helper-58525",
        storageBucket: "super-helper-58525.firebasestorage.app",
        messagingSenderId: "730201633624",
        appId: "1:730201633624:web:9c001a7d4ee32ee94cab2d"
    });

    // 定義應用程式 ID，程式碼會用它作為資料庫的路徑層級
    var __app_id = "my-summary-app-01"; 

    // 如果有特定的 Token 可以在此傳入，否則會執行匿名登入
    var __initial_auth_token = ""; 
</script>
    <script type="module">
        // 1. 匯入 Firebase SDK (這段非常重要，讓瀏覽器知道去哪裡抓功能)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 全域變數與設定 ---
        const DEFAULT_ARTICLE = `　　美如奶奶個子不高，有著圓圓的臉蛋、一頭灰白的短髮。她常常穿著一件藍色的工作圍裙，戴著一副紫色的眼鏡，滿臉笑容，看起來特別有活力。
　　放學後，我們最喜歡到「小書店」了！美如奶奶在店裡很忙，她有時會把書架上的書一本本排好，有時會仔細收拾文具區散落的東西。我們喜歡在書店裡看書，有時看著看著，忍不住大聲討論起來，像吵鬧的小麻雀。這時候美如奶奶會靠過來，對我們微微笑，比出一個「請安靜」的魔法暗號。
　　書店雖然很小，不過東西不少，美如奶奶的腦子裡好像有部電腦，總是知道什麼東西放在哪裡。假如有人問：「我們要做科展，該看什麼書呢？」一本九十九個好玩的科學遊戲就會交到他手上。假如有人問：「有沒有教人怎麼變魔術的書？」她會幫忙找出一本小小魔術師。假如有人要買水彩筆、筆記本、卡紙……她都能很快的幫助大家找出來。
　　書店不忙的時候，美如奶奶會坐在一張特製的高腳椅上專心看書。書店裡有張小小的標語寫著：「天底下最棒的事情，就是跟書本成為朋友。」常到書店的我們，因為美如奶奶，也跟書本變成好朋友，成為真正的愛書人。`;
        
        const PRONOUNS = ['我', '你', '他', '她', '它', '我們', '你們', '他們'];
        const PUNCTUATIONS = ['、', '，', '。', '！', '？', '：', '「', '」'];
        const CONJUNCTIONS = ['首先', '然後', '接著', '最後', '因為', '所以', '但是', '可是', '而且', '不過', '另外', '總之'];
        const HINTS = {
            q1: ["🤔 如果不懂，試著重新讀一遍這段，找出關鍵詞！", "✨ 理解是摘要的第一步，慢慢來沒關係！"],
            q2: ["🎯 重點通常在段落的開頭或結尾！", "✨ 重點通常是在說「誰做了什麼」或「什麼是什麼」"],
            q3: ["🗑️ 具體的數字、時間、地點細節可以考慮刪除", "✂️ 形容詞、副詞通常可以刪除"]
        };
        
       // --- 修正後的 AI 設定 ---
　　　　// 將這裡換成剛剛新建立的那組金鑰 (不要用 Firebase Config 裡的那組)
　　　　const apiKey = "";

        // 2. Firebase 設定 (您的專案資訊)
        const firebaseConfig = {
            apiKey: "AIzaSyDnpeXA16Lig0yhcvuAxRk5o1MiS6yKikE",
            authDomain: "super-helper-58525.firebaseapp.com",
            projectId: "super-helper-58525",
            storageBucket: "super-helper-58525.firebasestorage.app",
            messagingSenderId: "730201633624",
            appId: "1:730201633624:web:9c001a7d4ee32ee94cab2d",
            measurementId: "G-0L0CVM4D6P"
        };

        // 3. 設定應用程式 ID (這是資料庫儲存的路徑名稱)
        const appId = 'super-helper-app-v1';

        let user = null;
        let db = null;
        let originalText = DEFAULT_ARTICLE;
        let currentSubmissions = [];
        let currentArticles = [];
        let stats = { originalLength: 0, deletedChars: 0, keptChars: 0, ratio: 100, deletionFragments: 0 };
        let studentInfo = { name: '', seatNumber: '' };
        let checks = { check1: null, check2: null, check3: null, check4: null, confidence: null };
        let hintIndices = { q1: 0, q2: 0, q3: 0 };
// --- 新增這一行 ---
        let hintClickCount = 0;

        // --- 初始化 Firebase (已修正) ---
        function initFirebase() {
            try {
                console.log("正在連接 Firebase...");
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);

                // 執行匿名登入
                signInAnonymously(auth).catch((error) => {
                    console.error("登入失敗:", error);
                    alert("⚠️ 無法登入 Firebase，請確認是否已在 Console 開啟「匿名登入」功能。");
                });
                
                // 監聽登入狀態
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if(user) {
                        console.log("Firebase 連線成功! User ID:", user.uid);
                        loadArticles();
                        if(document.getElementById('teacher-dashboard').style.display === 'flex') {
                            loadSubmissions();
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase init error:", e);
                alert("Firebase 初始化發生錯誤，請按 F12 查看 Console");
            }
        }

        // --- 核心邏輯 ---

        // 刪除/復原功能
// ==========================================
        //       🎨 螢光筆與刪除功能整合包
        // ==========================================

        // 1. 處理刪除/復原 (原本的功能)
        window.handleDeleteSelection = function() {
            const sel = window.getSelection();
            if(!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            const container = document.getElementById('deletion-area');
            
            // 檢查是否在編輯區內
            if(!container.contains(range.commonAncestorContainer)) return;
            if(range.toString().length === 0) return;

            // 建立刪除線標籤 (紅字)
            const span = document.createElement('span');
            span.className = "deletion-text"; 
            span.title = "點擊以復原";
            
            try {
                range.surroundContents(span);
                sel.removeAllRanges(); // 取消選取
                updateStats(); // 更新字數統計
            } catch(e) {
                alert("⚠️ 無法標記：請選取完整的文字，不要跨越多個段落喔！");
            }
        }

        // 2. 處理黃色螢光筆 (新功能)
        window.handleHighlightSelection = function() {
            const sel = window.getSelection();
            if(!sel.rangeCount) return;

            let node = sel.anchorNode;
            // 如果點擊在文字上，抓取其父元素檢查是否已經是螢光筆
            if(node.nodeType === 3) node = node.parentNode;
            
            // 如果已經是螢光筆，就取消 (變回普通文字)
            if(node.classList.contains('highlight-text')) {
                const text = node.innerText;
                const textNode = document.createTextNode(text);
                node.parentNode.replaceChild(textNode, node);
                return;
            }

            const range = sel.getRangeAt(0);
            const container = document.getElementById('deletion-area');
            
            // 檢查是否在編輯區內
            if(!container.contains(range.commonAncestorContainer)) return;
            if(range.toString().length === 0) return;

            // 建立螢光筆標籤 (黃底)
            const span = document.createElement('span');
            span.className = "highlight-text"; 
            span.title = "點擊以取消重點";
            
            try {
                range.surroundContents(span);
                sel.removeAllRanges(); // 取消選取
            } catch(e) {
                alert("⚠️ 無法標記：請選取完整的文字，不要跨越多個段落喔！");
            }
        }

        // 3. 統一管理點擊事件 (點擊紅字復原、點擊黃字取消)
        // ⚠️ 請確保這段程式碼在整份文件中只出現一次
        const delArea = document.getElementById('deletion-area');
        // 先移除舊的監聽器 (雖然 HTML 無法直接移除匿名函式，但放在這裡是為了提醒覆蓋位置)
        // 這裡使用新的監聽邏輯：
        if (delArea) {
            // 為了避免重複綁定，我們使用 onclick 屬性覆蓋，或者確認這是唯一的 addEventListener
            delArea.onclick = (e) => {
                // 情況 A: 點擊紅字 (取消刪除)
                if(e.target.classList.contains('deletion-text')) {
                    const text = e.target.innerText;
                    const textNode = document.createTextNode(text);
                    e.target.parentNode.replaceChild(textNode, e.target);
                    updateStats(); // 更新右邊摘要與統計
                }
                // 情況 B: 點擊黃底 (取消重點)
                else if(e.target.classList.contains('highlight-text')) {
                    const text = e.target.innerText;
                    const textNode = document.createTextNode(text);
                    e.target.parentNode.replaceChild(textNode, e.target);
                    // 螢光筆不影響字數統計，所以不用 updateStats
                }
            };
        }

function updateStats() {
            const container = document.getElementById('deletion-area');
            
            // --- 新增功能：同步到摘要區 ---
            // 1. 複製一份目前的內容，這樣操作才不會影響到原本的畫面
            const clone = container.cloneNode(true);
            
            // 2. 找出所有被標記為「刪除」的紅字，計算長度並移除它們
            const deletedNodes = clone.querySelectorAll('.deletion-text');
            let deletedLen = 0;
            deletedNodes.forEach(node => {
                deletedLen += node.innerText.length;
                node.remove(); // 從複製的內容中移除
            });
            
            // 3. 剩下的就是「保留下來」的文字，同步到右邊摘要區
            const remainingText = clone.innerText;
            document.getElementById('summary-area').innerText = remainingText;

            // --- 更新統計數據 ---
            // 取得目前左邊區域的總字數 (包含紅字)，確保如果學生有手動改字，數據也是對的
            const currentTotalText = container.innerText;
            
            // 如果需要，也可以在這裡順便更新全域變數，確保提交時是最新版本
            // originalText = currentTotalText; 
            
            const origLen = currentTotalText.length;
            const kept = Math.max(0, origLen - deletedLen);
            const ratio = origLen > 0 ? Math.round((kept / origLen) * 100) : 0;

            stats = {
                originalLength: origLen,
                deletedChars: deletedLen,
                keptChars: kept,
                ratio: ratio,
                deletionFragments: deletedNodes.length
            };

            document.getElementById('stat-original').innerText = stats.originalLength;
            document.getElementById('stat-deleted').innerText = stats.deletedChars;
            document.getElementById('stat-kept').innerText = stats.keptChars;
            document.getElementById('stat-ratio').innerText = stats.ratio + '%';
            document.getElementById('stat-fragments').innerText = stats.deletionFragments;
        }
        
        window.insertText = function(text) {
            const div = document.getElementById('summary-area');
            div.focus();
            document.execCommand('insertText', false, text);
        }

        function initToolbar() {
            const container = document.getElementById('toolbar-buttons');
            const createGroup = (items, colorClass, title) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-1";
                div.innerHTML = `<span class="text-[10px] font-bold ${colorClass} px-1.5 py-0.5 rounded">${title}</span>`;
                items.forEach(t => {
                    const btn = document.createElement('button');
                    btn.innerText = t;
                    let btnClass = "";
                    if(colorClass.includes("purple")) btnClass = "bg-purple-50 text-purple-700 border-purple-200 hover:bg-purple-100";
                    else if(colorClass.includes("blue")) btnClass = "bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100";
                    else btnClass = "bg-green-50 text-green-700 border-green-200 hover:bg-green-100";
                    
                    btn.className = `${btnClass} border px-2 py-1 rounded-lg text-sm font-bold active:scale-95 transition-all`;
                    btn.onclick = () => insertText(t);
                    div.appendChild(btn);
                });
                return div;
            };
            container.appendChild(createGroup(PRONOUNS, "text-purple-600 bg-purple-100", "代名詞"));
            container.appendChild(createGroup(PUNCTUATIONS, "text-blue-600 bg-blue-100", "標點"));
            container.appendChild(createGroup(CONJUNCTIONS, "text-green-600 bg-green-100", "連接詞"));
        }

// --- AI 功能 (最終修正版：使用 Gemini 2.0) ---
        async function callAI(prompt) {
            // 使用您已驗證成功的新金鑰
            const key = apiKey; 
            
            if(!key || key.includes("請輸入")) {
                alert("⚠️ 請檢查程式碼中的 apiKey 是否已填入正確的金鑰！");
                return "⚠️ 金鑰設定錯誤";
            }

            // 為了除錯，我們在 Console 印出正在使用的模型
            console.log("正在呼叫 AI...");

            try {
                // 修改點：根據您的清單，改用 'gemini-2.0-flash'
                // 這是您清單中確認可用的模型
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    }
                );
                
                if(!response.ok) {
                    const errorData = await response.json();
                    console.error("API 錯誤:", errorData);
                    return `⚠️ 連線失敗 (${response.status})：請看 F12 Console 的詳細錯誤。`;
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    return "⚠️ AI 沒有回傳任何文字，可能被安全過濾攔截。";
                }

            } catch(e) {
                console.error("程式執行錯誤:", e);
                return `⚠️ 系統錯誤：${e.message}`;
            }
        }

        window.askAIHint = async function() {
            const btn = document.getElementById('btn-ask-hint');
            const contentDiv = document.getElementById('ai-hint-content');
            const textDiv = document.getElementById('ai-hint-text');
            
            btn.innerHTML = `<span class="animate-spin">🔄</span> AI 正在思考...`;
            
            let prompt = "";

            // --- 判斷是第幾次點擊 ---
            if (hintClickCount === 0) {
                // 第一次：給 3 個重點 (全貌)
                prompt = `你是國小三年級學生的閱讀小幫手。這篇文章內容是：「${originalText}」。請找出最重要的3個關鍵重點，用條列式，簡單語氣，總字數60字以內。`;
            } else {
                // 第二次以上：逐段提問 (細節引導)
                prompt = `你是引導思考的閱讀老師。這篇文章內容是：「${originalText}」。
                請將文章「逐段」拆解，針對每一段提出一個「引導式提問」(用問句啟發學生思考，不要直接給答案)。
                
                請依照以下格式輸出：
                第一段思考：[針對第一段的提問]
                第二段思考：[針對第二段的提問]
                ...以此類推，包含所有段落。`;
            }

            const result = await callAI(prompt);
            
            // 增加計數，這樣下次點擊就會進入「逐段提問」模式
            hintClickCount++;

            // 更新 UI
            if (hintClickCount === 1) {
                // 第一次點完後，改變按鈕文字提示學生可以再點一次
                btn.innerHTML = `<i data-lucide="zoom-in"></i> 🔍 想看更細的逐段提示？再點我一次`;
            } else {
                btn.innerHTML = `<i data-lucide="lightbulb"></i> 🔑 找不到重點？問問 AI 小偵探`;
            }
            
            btn.style.display = 'none';
            contentDiv.classList.remove('hidden');
            typewriter(textDiv, result || "⚠️ AI 無法回應");
        }
        window.closeAIHint = function() {
            document.getElementById('ai-hint-content').classList.add('hidden');
            document.getElementById('btn-ask-hint').style.display = 'flex';
        }

        window.askAIFeedback = async function() {
            const summary = document.getElementById('summary-area').innerText;
            if(summary.length < 10) { alert("請先寫多一點內容喔！"); return; }

            const btn = document.getElementById('btn-ask-feedback');
            const contentDiv = document.getElementById('ai-feedback-content');
            const textDiv = document.getElementById('ai-feedback-text');

            btn.innerHTML = `<span class="animate-spin">🔄</span> AI 正在改作業...`;

            const prompt = `你是溫柔且專業的國小閱讀寫作老師。請批改學生的摘要作業。

原文：「${originalText}」
學生摘要：「${summary}」

**【評分規則】：基準分 85 分。**
請根據學生的表現，從 85 分開始進行「加分」或「扣分」，範圍控制在 **80分 ~ 100分** 之間。

**評分邏輯：**
1. **加分區 (85 → 100)**：若表現優良，每個向度可加 1~5 分。若寫得非常完美，請不吝給予 100 分。
2. **扣分區 (85 → 80)**：若發生「刪減太多導致看不懂」、「亂改原文」或「重點完全遺漏」，請從 85 分酌量扣分，最低給 80 分。

請針對以下三個向度評估：

1. 【重點涵蓋率】(最高加 5 分)：
   - (5分) 表現優良：涵蓋所有重要概念或主要事件，能完整呈現段落/全文大意。
   - (3-4分) 表現良好：涵蓋大部分重點，僅少數重要資訊遺漏。
   - (1-2分) 須再加強：僅涵蓋部分重點，遺漏多數重要資訊。
   - (0分) 表現不足：幾乎無法抓住文章重點，內文不完整或偏離主題。

2. 【簡潔與刪減能力】(最高加 5 分)：
   - (5分) 表現優良：能刪除冗餘訊息，內容精煉，無不必要細節。
   - (3-4分) 表現良好：大部分刪除不必要細節，仍留有些許冗餘資訊。
   - (1-2分) 須再加強：只刪除少部分不重要訊息，仍有大量冗餘或不必要內容。
   - (0分) 表現不足：幾乎未刪除冗餘內容，或僅抄寫原文句子。

3. 【語句流暢度】(最高加 5 分)：
   - (5分) 表現優良：語句組合順暢，表達清晰，具備邏輯性。
   - (3-4分) 表現良好：語句組合大致順暢，部分語句雖不構精煉但能理解。
   - (1-2分) 須再加強：語句間缺乏連貫性，前後銜接不順，影響閱讀。
   - (0分) 表現不足：語句結構混亂，或僅為原文抄錄，缺乏組織。

請依照以下格式輸出：
總分：[計算後的總分]/100
評語：
1. [針對重點涵蓋率的具體評語]
2. [針對簡潔與刪減能力的具體評語]
3. [針對語句流暢度的具體評語]
(最後給一句溫柔鼓勵的話，若分數較低請給予明確指引，若滿分請給予大力稱讚)`;
            const result = await callAI(prompt);

            btn.innerHTML = `<i data-lucide="message-circle"></i> 👩‍🏫 寫好了？請 AI 老師看一下`;

            btn.style.display = 'none';
            contentDiv.classList.remove('hidden');
            typewriter(textDiv, result || "⚠️ AI 無法回應");
        }

        window.closeAIFeedback = function() {
            document.getElementById('ai-feedback-content').classList.add('hidden');
            document.getElementById('btn-ask-feedback').style.display = 'flex';
        }

        function typewriter(element, text) {
            element.innerText = "";
            let i = 0;
            const timer = setInterval(() => {
                if(i < text.length) {
                    element.innerText += text.charAt(i);
                    i++;
                } else clearInterval(timer);
            }, 20);
        }

        // --- 提示卡功能 ---
        window.showHint = function(id) {
            const list = HINTS[id];
            const idx = hintIndices[id];
            document.getElementById('hint-display').innerText = list[idx];
            hintIndices[id] = (idx + 1) % list.length;
        }

// --- 自我檢核與資訊 ---
        function initChecklist() {
            const container = document.getElementById('checklist-container');
            
            // 修改點：在這裡定義每個問題的「正面回答 (yesBtn)」與「負面回答 (noBtn)」
            const questions = [
                {
                    id: 'check1', 
                    text: '我寫的摘要有把重點說清楚嗎？', 
                    icon: 'book-open', 
                    color: 'orange',
                    yesBtn: '有', 
                    noBtn: '還不太確定'
                },
                {
                    id: 'check2', 
                    text: '還有哪裡看不懂或不太確定嗎？', 
                    icon: 'help-circle', 
                    color: 'purple',
                    yesBtn: '沒有', // 「沒有」看不懂 = 正面狀態
                    noBtn: '有'
                },
                {
                    id: 'check3', 
                    text: '刪掉的都是不重要的嗎？', 
                    icon: 'trash-2', 
                    color: 'red',
                    yesBtn: '是', 
                    noBtn: '還不太確定'
                },
                {
                    id: 'check4', 
                    text: '句子讀起來通順嗎？', 
                    icon: 'pen-tool', 
                    color: 'cyan',
                    yesBtn: '通順', 
                    noBtn: '不太通順'
                }
            ];

            // 先清空容器 (避免重複渲染)
            container.innerHTML = '';

            questions.forEach(q => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl border-2 bg-white border-dashed border-gray-300 transition-all`;
                div.innerHTML = `
                    <div class="flex items-start gap-3 mb-2">
                        <div class="p-1 rounded-full bg-gray-100 text-gray-400"><i data-lucide="${q.icon}"></i></div>
                        <p class="font-bold text-gray-800">${q.text}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateCheck('${q.id}', true, this)" class="flex-1 py-2 rounded-lg border text-sm font-bold hover:bg-gray-50">${q.yesBtn}</button>
                        <button onclick="updateCheck('${q.id}', false, this)" class="flex-1 py-2 rounded-lg border text-sm font-bold hover:bg-gray-50">${q.noBtn}</button>
                    </div>
                `;
                container.appendChild(div);
            });

            // 信心按鈕 (保持不變)
            const confContainer = document.getElementById('confidence-container');
            // 清空信心區塊避免重複 (安全起見)
            confContainer.innerHTML = '';
            
            const confs = [
                {val: 'good', text: '我覺得很好！', emoji: '😄'},
                {val: 'ok', text: '我覺得還可以', emoji: '🙂'},
                {val: 'unsure', text: '我不太確定', emoji: '🤔'}
            ];
            confs.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "rounded-2xl font-bold text-sm border-b-4 bg-white border-yellow-200 text-yellow-600 hover:bg-yellow-100 flex flex-col items-center justify-center p-2 transition-all active:scale-95";
                btn.innerHTML = `<span class="text-2xl">${c.emoji}</span><span>${c.text}</span>`;
                btn.onclick = () => {
                    checks.confidence = c.val;
                    // Reset style
                    Array.from(confContainer.children).forEach(b => b.className = b.className.replace('bg-yellow-400 border-yellow-600 text-white', 'bg-white border-yellow-200 text-yellow-600'));
                    // Set active
                    btn.className = btn.className.replace('bg-white border-yellow-200 text-yellow-600', 'bg-yellow-400 border-yellow-600 text-white');
                    updateStudentInfo();
                };
                confContainer.appendChild(btn);
            });
        }
        window.updateCheck = function(id, val, btn) {
            checks[id] = val;
            const parent = btn.parentNode;
            const card = parent.parentNode;
            // Visual update
            const color = id === 'check1' ? 'orange' : id === 'check3' ? 'red' : id === 'check4' ? 'cyan' : 'purple';
            if(val) {
                card.className = `p-4 rounded-2xl border-2 bg-${color}-50 border-${color}-400 shadow-md transition-all`;
                // Reset buttons
                Array.from(parent.children).forEach(b => b.className = "flex-1 py-2 rounded-lg border text-sm font-bold bg-white text-gray-500");
                btn.className = `flex-1 py-2 rounded-lg text-sm font-bold bg-${color}-500 text-white shadow`;
            } else {
                card.className = `p-4 rounded-2xl border-2 bg-gray-50 border-gray-200 transition-all`;
                Array.from(parent.children).forEach(b => b.className = "flex-1 py-2 rounded-lg border text-sm font-bold bg-white text-gray-500");
                btn.className = "flex-1 py-2 rounded-lg text-sm font-bold bg-gray-500 text-white shadow";
            }
        }

        window.updateStudentInfo = function() {
            studentInfo.name = document.getElementById('input-name').value;
            studentInfo.seatNumber = document.getElementById('input-seat').value;
            
            document.getElementById('display-student-name').innerText = `${studentInfo.name || '學生姓名'} (座號: ${studentInfo.seatNumber || '?'})`;
            const map = { good: '我覺得很好！', ok: '我覺得還可以', unsure: '我不太確定' };
            document.getElementById('display-confidence').innerText = map[checks.confidence] || '尚未評估';
        }

        // --- 截圖功能 ---
        window.handleDownloadSnapshot = async function() {
            const el = document.getElementById('workspace-card');
            const btn = document.getElementById('btn-snapshot');
            btn.innerText = "處理中...";
            
            try {
                const canvas = await html2canvas(el, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    windowWidth: 1280, // 強制電腦版寬度
                    onclone: (doc) => {
                        // 強制 Grid 佈局
                        const grid = doc.getElementById('workspace-grid');
                        grid.style.display = 'grid';
                        grid.style.gridTemplateColumns = '1fr 1fr';
                        grid.classList.remove('grid-cols-1', 'lg:grid-cols-2');

                        // 隱藏工具列與 AI
                        doc.getElementById('quick-toolbar').style.display = 'none';
                        doc.getElementById('ai-hint-section').style.display = 'none';
                        doc.getElementById('ai-feedback-section').style.display = 'none';
                        doc.getElementById('btn-snapshot').style.display = 'none'; // 隱藏下載按鈕自己

                        // 展開文字區
                        const expand = (id) => {
                            const d = doc.getElementById(id);
                            d.style.height = 'auto';
                            d.style.overflow = 'visible';
                        };
                        expand('deletion-area');
                        expand('summary-area');
                    }
                });
                const link = document.createElement('a');
                link.download = `${studentInfo.name || '作業'}_摘要.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch(e) {
                console.error(e);
                alert("截圖失敗");
            } finally {
                btn.innerHTML = `<i data-lucide="download" class="w-4 h-4"></i> 下載截圖`;
                lucide.createIcons();
            }
        }

        // --- 提交與資料庫 ---
        window.handleSubmit = async function() {
            if(!db || !user) { alert("資料庫未連線，請檢查網路或稍後再試"); return; }
            if(!studentInfo.name) { alert("請填寫姓名"); return; }
            
            const btn = document.querySelector('button[onclick="handleSubmit()"]');
            const originalTextBtn = btn.innerText;
            btn.innerText = "提交中...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'student_summaries'), {
                    userId: user.uid,
                    studentInfo,
                    originalText,
                    deletionHtml: document.getElementById('deletion-area').innerHTML,
                    finalSummary: document.getElementById('summary-area').innerText,
                    checks,
                    stats,
                    createdAt: serverTimestamp()
                });
                alert("🎉 作業提交成功！太棒了！");
            } catch(e) {
                console.error(e);
                alert("❌ 提交失敗：\n" + e.message + "\n請確認 Firebase Rules 是否已設定為開放測試。");
            } finally {
                btn.innerText = originalTextBtn;
                btn.disabled = false;
            }
        }

        // --- 文章管理 ---
        window.toggleArticleModal = function() {
            const modal = document.getElementById('article-modal');
            modal.classList.toggle('hidden');
        }

        function loadArticles() {
            if(!db) return;
            // 監聽文章變化
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'articles'));
            onSnapshot(q, (snapshot) => {
                currentArticles = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderArticleList();
            }, (error) => {
                console.error("Error loading articles:", error);
                // 權限不足時不報錯，僅安靜失敗 (一般學生不需讀取列表，除非是老師)
            });
        }

        function renderArticleList() {
            const list = document.getElementById('article-list');
            list.innerHTML = '';
            
            // 預設文章
            const defaultDiv = document.createElement('div');
            defaultDiv.className = "bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-xl border border-indigo-100 cursor-pointer hover:shadow-md";
            defaultDiv.innerHTML = `<h4 class="font-bold text-indigo-800">🐰 遇見美如奶奶 (預設)</h4><p class="text-sm text-gray-600 line-clamp-2">${DEFAULT_ARTICLE}</p>`;
            defaultDiv.onclick = () => selectArticle(DEFAULT_ARTICLE);
            list.appendChild(defaultDiv);

            // 自訂文章
            const customDiv = document.createElement('div');
            customDiv.className = "bg-gray-50 border-2 border-dashed border-gray-300 p-4 rounded-xl text-center cursor-pointer hover:bg-gray-100";
            customDiv.innerHTML = `<span class="font-bold text-gray-500"><i data-lucide="pen-tool"></i> 貼上自己的文章</span>`;
            customDiv.onclick = () => {
                const text = prompt("請貼上文章：");
                if(text) selectArticle(text);
            };
            list.appendChild(customDiv);

            // 資料庫文章
            currentArticles.forEach(art => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl border hover:border-indigo-300 cursor-pointer hover:shadow-md";
                div.innerHTML = `<h4 class="font-bold">${art.title}</h4><p class="text-sm text-gray-500 line-clamp-2">${art.content}</p>`;
                div.onclick = () => selectArticle(art.content);
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        function selectArticle(text) {
            originalText = text;
            document.getElementById('deletion-area').innerHTML = text;
            document.getElementById('summary-area').innerText = text;
            updateStats();
            toggleArticleModal();
// --- 新增這一行：換文章時，提示也要重頭開始 ---
            hintClickCount = 0; 
        }

        // --- 教師後台 ---
        window.toggleTeacherModal = function() {
            document.getElementById('teacher-modal').classList.toggle('hidden');
        }

        window.teacherLogin = function() {
            const pwd = document.getElementById('teacher-password').value;
            if(pwd === '1234') {
                document.getElementById('teacher-login').classList.add('hidden');
                document.getElementById('teacher-dashboard').style.display = 'flex';
                loadSubmissions();
            } else {
                alert("密碼錯誤");
            }
        }

        window.switchTeacherTab = function(tab) {
            const subView = document.getElementById('view-submissions');
            const artView = document.getElementById('view-articles');
            const tabSub = document.getElementById('tab-submissions');
            const tabArt = document.getElementById('tab-articles');

            if(tab === 'submissions') {
                subView.classList.remove('hidden');
                subView.classList.add('flex');
                artView.classList.add('hidden');
                artView.classList.remove('flex');
                tabSub.className = tabSub.className.replace('text-gray-400 border-transparent', 'text-indigo-600 border-indigo-600');
                tabArt.className = tabArt.className.replace('text-indigo-600 border-indigo-600', 'text-gray-400 border-transparent');
                document.getElementById('sort-controls').classList.remove('hidden');
            } else {
                subView.classList.add('hidden');
                subView.classList.remove('flex');
                artView.classList.remove('hidden');
                artView.classList.add('flex');
                tabArt.className = tabArt.className.replace('text-gray-400 border-transparent', 'text-indigo-600 border-indigo-600');
                tabSub.className = tabSub.className.replace('text-indigo-600 border-indigo-600', 'text-gray-400 border-transparent');
                document.getElementById('sort-controls').classList.add('hidden');
                renderArticlesManage();
            }
        }

        function loadSubmissions() {
            if(!db) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'student_summaries'));
            onSnapshot(q, (snapshot) => {
                currentSubmissions = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderSubmissions();
            }, (error) => {
                console.error("Error loading submissions:", error);
            });
        }

  // --- 1. 刪除作業函式 ---
window.deleteSubmission = async function(id) {
    if(!confirm("⚠️ 確定要永久刪除這份學生的作業嗎？刪除後無法復原喔！")) return;
    try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'student_summaries', id));
        alert("🗑️ 作業已刪除");
    } catch(e) {
        console.error("刪除失敗:", e);
        alert("刪除失敗");
    }
}

// --- 2. 渲染表格函式 (修正排序與顯示問題) ---
window.renderSubmissions = function() {
    const tbody = document.getElementById('submissions-body');
    const sort = document.getElementById('sort-select').value;
    if (!tbody) return;
    tbody.innerHTML = '';
    
    // 確保排序邏輯強健：處理座號為空的情況
    const sorted = [...currentSubmissions].sort((a, b) => {
        if(sort === 'seat') {
            const seatA = parseInt(a.studentInfo?.seatNumber) || 999;
            const seatB = parseInt(b.studentInfo?.seatNumber) || 999;
            return seatA - seatB;
        }
        // 預設按時間新到舊
        return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
    });

    document.getElementById('submission-count').innerText = sorted.length;

    sorted.forEach(sub => {
        const date = sub.createdAt ? new Date(sub.createdAt.seconds * 1000).toLocaleDateString() : '-';
        const tr = document.createElement('tr');
        tr.className = "hover:bg-white transition-colors border-b";
        
        // 確保使用反引號 (Template Literals)
        tr.innerHTML = `
            <td class="p-3 text-gray-500">${date}</td>
            <td class="p-3 font-bold text-gray-800">${sub.studentInfo?.name || '未填'}</td>
            <td class="p-3 text-gray-800">${sub.studentInfo?.seatNumber || '-'}</td>
            <td class="p-3 text-gray-800">${sub.stats?.originalLength || 0} / <span class="font-bold text-indigo-600">${sub.stats?.summaryLength || sub.finalSummary?.length || 0}</span></td>
            <td class="p-3 text-blue-700 font-bold bg-blue-50/30 border-l border-blue-50">${sub.stats?.ratio || 0}%</td>
            <td class="p-3 text-red-700 font-bold bg-red-50/30 border-l border-red-50">${sub.stats?.deletionFragments || 0}</td>
            <td class="p-3 text-2xl">${sub.checks?.confidence === 'good' ? '😄' : sub.checks?.confidence === 'ok' ? '🙂' : '🤔'}</td>
            <td class="p-3">
                <button onclick="deleteSubmission('${sub.id}')" class="text-red-400 hover:text-red-600 p-2 rounded-full">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    // 重新載入圖示
    if (window.lucide) lucide.createIcons();
}

// --- 3. 匯出 CSV 函式 ---
window.exportToCSV = function() {
    if(!currentSubmissions || currentSubmissions.length === 0) {
        alert("目前沒有資料可以匯出");
        return;
    }
    const headers = ['學生姓名', '座號', '原文字數', '摘要字數', '保留比例', '刪除片段', '自我評估', '提交時間', '摘要內容'];
    const rows = currentSubmissions.map(sub => [
        sub.studentInfo?.name || '', 
        sub.studentInfo?.seatNumber || '', 
        sub.stats?.originalLength || 0, 
        sub.stats?.summaryLength || sub.finalSummary?.length || 0, 
        (sub.stats?.ratio || 0) + '%',
        sub.stats?.deletionFragments || 0,
        sub.checks?.confidence || '',
        sub.createdAt ? new Date(sub.createdAt.seconds * 1000).toLocaleString('zh-TW') : '', 
        `"${(sub.finalSummary || "").replace(/"/g, '""')}"`
    ]);
    
    const csvContent = "\uFEFF" + [headers.join(','), ...rows.map(e => e.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `學生摘要作業統計_${new Date().toLocaleDateString()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

        // --- 啟動 ---
        initFirebase();
        initToolbar();
        selectArticle(DEFAULT_ARTICLE);
        initChecklist();
        lucide.createIcons();
    </script>
</body>
</html>
