<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…ç´šæ‘˜è¦å°å¹«æ‰‹ (HTMLç‰ˆ)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- å¼•å…¥ html2canvas ç”¨æ–¼æˆªåœ– -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        .deletion-text {
            color: #dc2626; /* red-600 */
            font-weight: bold;
            cursor: pointer;
        }
        .deletion-text:hover {
            color: #b91c1c; /* red-700 */
        }
        [contenteditable]:focus {
            outline: none;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans pb-32">

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-indigo-100">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                    <i data-lucide="book-open"></i>
                </div>
                <h1 class="text-2xl font-bold text-indigo-900">è¶…ç´šæ‘˜è¦å°å¹«æ‰‹</h1>
            </div>
            <button onclick="toggleTeacherModal()" class="text-gray-300 hover:text-indigo-600 p-2 transition-colors">
                <i data-lucide="user"></i>
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
        
        <!-- ç†è§£ç›£æ§ä¸‰éšæ®µ -->
        <section class="bg-white/80 backdrop-blur-sm rounded-3xl p-6 shadow-lg border border-indigo-50">
            <div class="flex items-center gap-3 mb-8 pb-2 border-b border-gray-100">
                <span class="text-3xl bg-indigo-100 p-2 rounded-lg">ğŸ§ </span>
                <h2 class="text-2xl font-bold text-indigo-800">ç†è§£ç›£æ§ä¸‰éšæ®µ</h2>
                <span class="text-sm text-gray-500 ml-auto">è·Ÿè‘—æ­¥é©Ÿåšï¼Œæ‘˜è¦è®Šç°¡å–®ï¼</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Stage 1 -->
                <div class="group relative overflow-hidden bg-white rounded-2xl border-2 border-blue-100 shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-cyan-300"></div>
                    <div class="p-5 flex items-center gap-3 bg-blue-50/50 border-b border-blue-100">
                        <div class="bg-white p-2 rounded-lg shadow-sm text-blue-600"><i data-lucide="book-open"></i></div>
                        <h3 class="text-xl font-bold text-blue-800">é–±è®€å‰</h3>
                        <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full font-bold ml-auto">è¨­å®šæ‘˜è¦ç›®æ¨™</span>
                    </div>
                    <div class="p-5 flex-grow space-y-4">
                        <p class="text-gray-500 font-bold mb-4 text-sm uppercase tracking-wide">æˆ‘è¦åšåˆ°ï¼š</p>
                        <div class="flex items-start gap-3"><span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0 shadow-md">1</span><span class="text-gray-700 font-medium pt-0.5">æˆ‘è¦æ‰¾å‡ºæ¯æ®µæœ€é‡è¦çš„å…§å®¹</span></div>
                        <div class="flex items-start gap-3"><span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0 shadow-md">2</span><span class="text-gray-700 font-medium pt-0.5">æˆ‘è¦åˆªæ‰ä¸é‡è¦æˆ–å¤šé¤˜çš„ç´°ç¯€</span></div>
                        <div class="flex items-start gap-3"><span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shrink-0 shadow-md">3</span><span class="text-gray-700 font-medium pt-0.5">æˆ‘è¦æŠŠå¥å­æ’å¾—é †ä¸€é»</span></div>
                    </div>
                </div>
                <!-- Stage 2 -->
                <div class="group relative overflow-hidden bg-white rounded-2xl border-2 border-yellow-100 shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-400 to-orange-300"></div>
                    <div class="p-5 flex items-center gap-3 bg-yellow-50/50 border-b border-yellow-100">
                        <div class="bg-white p-2 rounded-lg shadow-sm text-yellow-600"><i data-lucide="search"></i></div>
                        <h3 class="text-xl font-bold text-yellow-800">é–±è®€ä¸­</h3>
                        <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full font-bold ml-auto">é‚Šè®€é‚Šæƒ³</span>
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <p class="text-gray-500 font-bold mb-4 text-sm uppercase tracking-wide">è‡ªæˆ‘æå•èˆ‡æ¸¬é©—ï¼š</p>
                        <div class="space-y-3 mb-4">
                            <button onclick="showHint('q1')" class="w-full bg-white p-3 rounded-xl border-2 border-yellow-100 text-gray-700 shadow-sm text-left font-bold hover:bg-yellow-50 transition-all flex justify-between items-center">
                                <span>ğŸ¤” æˆ‘çœŸçš„æ‡‚é€™æ®µåœ¨èªªä»€éº¼å—ï¼Ÿ</span>
                            </button>
                            <button onclick="showHint('q2')" class="w-full bg-white p-3 rounded-xl border-2 border-yellow-100 text-gray-700 shadow-sm text-left font-bold hover:bg-yellow-50 transition-all flex justify-between items-center">
                                <span>ğŸ¯ é€™æ®µçš„é‡é»æ˜¯ä»€éº¼ï¼Ÿ</span>
                            </button>
                            <button onclick="showHint('q3')" class="w-full bg-white p-3 rounded-xl border-2 border-yellow-100 text-gray-700 shadow-sm text-left font-bold hover:bg-yellow-50 transition-all flex justify-between items-center">
                                <spanâœ‚ï¸ æœ‰å“ªäº›ç´°ç¯€å¯ä»¥åˆªæ‰ï¼Ÿ</span>
                            </button>
                        </div>
                        <div id="hint-display" class="relative bg-yellow-100/50 p-4 rounded-xl border border-yellow-200 text-yellow-900 text-sm font-bold text-center shadow-inner mb-4">
                            é»æ“Šä¸Šæ–¹æŒ‰éˆ•é€²è¡Œç†è§£æª¢æŸ¥...
                        </div>
                    </div>
                </div>
                <!-- Stage 3 -->
                <div class="group relative overflow-hidden bg-white rounded-2xl border-2 border-green-100 shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-emerald-300"></div>
                    <div class="p-5 flex items-center gap-3 bg-green-50/50 border-b border-green-100">
                        <div class="bg-white p-2 rounded-lg shadow-sm text-green-600"><i data-lucide="clipboard-list"></i></div>
                        <h3 class="text-xl font-bold text-green-800">é–±è®€å¾Œ</h3>
                        <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full font-bold ml-auto">è‡ªæˆ‘æª¢æŸ¥</span>
                    </div>
                    <div class="p-5 flex-grow">
                        <p class="text-gray-500 font-bold mb-4 text-sm uppercase tracking-wide">å®Œæˆå¾Œå•è‡ªå·±ï¼š</p>
                        <ul class="space-y-4 text-gray-700 font-medium">
                            <li class="flex gap-3"><i data-lucide="check-circle" class="text-green-500 w-5 h-5 shrink-0"></i> æˆ‘å¯«çš„æ‘˜è¦æœ‰æŠŠé‡é»èªªæ¸…æ¥šå—ï¼Ÿ</li>
                            <li class="flex gap-3"><i data-lucide="check-circle" class="text-green-500 w-5 h-5 shrink-0"></i> é‚„æœ‰å“ªè£¡çœ‹ä¸æ‡‚å—ï¼Ÿ</li>
                            <li class="flex gap-3"><i data-lucide="check-circle" class="text-green-500 w-5 h-5 shrink-0"></i> åˆªæ‰çš„éƒ½æ˜¯ä¸é‡è¦çš„å—ï¼Ÿ</li>
                            <li class="flex gap-3"><i data-lucide="check-circle" class="text-green-500 w-5 h-5 shrink-0"></i> å¥å­è®€èµ·ä¾†é€šé †å—ï¼Ÿ</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- ä½œæ¥­å€ (å¯æˆªåœ–ç¯„åœ) -->
        <section id="workspace-card" class="bg-white rounded-2xl border-2 border-blue-200 shadow-lg overflow-hidden">
            <!-- æ¨™é ­ -->
            <div class="bg-blue-50/50 p-4 border-b border-blue-100">
                <div class="text-center mb-4 relative">
                    <h2 class="text-2xl font-bold text-blue-900 flex items-center justify-center gap-2">
                        <i data-lucide="camera" class="text-gray-600"></i> å­¸ç”Ÿä½œæ¥­æˆªåœ–
                    </h2>
                    <button onclick="handleDownloadSnapshot()" id="btn-snapshot" class="absolute right-0 top-1/2 -translate-y-1/2 bg-white text-blue-600 border border-blue-200 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 hover:bg-blue-50 transition-colors shadow-sm">
                        <i data-lucide="download" class="w-4 h-4"></i> ä¸‹è¼‰æˆªåœ–
                    </button>
                </div>
                <div class="flex justify-between items-center px-2">
                    <div class="flex items-center gap-2 text-lg font-bold text-gray-700">
                        <i data-lucide="user" class="text-purple-700"></i>
                        <span id="display-student-name">å­¸ç”Ÿå§“å (åº§è™Ÿ: ?)</span>
                    </div>
                    <div class="flex items-center gap-2 text-lg font-bold">
                        <span class="text-orange-500 text-2xl">ğŸ’ª</span>
                        <span id="display-confidence" class="text-purple-700">å°šæœªè©•ä¼°</span>
                    </div>
                </div>
            </div>

            <!-- çµ±è¨ˆåˆ— -->
            <div class="bg-purple-50 px-6 py-3 flex flex-wrap gap-6 items-center text-sm md:text-base justify-between border-b border-purple-100">
                <div class="flex items-center gap-2 font-bold text-purple-700">
                    <i data-lucide="bar-chart-2" class="text-green-600"></i> æ‘˜è¦çµ±è¨ˆ
                </div>
                <div class="flex gap-4 font-bold text-gray-600">
                    <div>ç¸½å­—æ•¸: <span id="stat-original" class="text-blue-600">0</span></div>
                    <div>åˆªé™¤: <span id="stat-deleted" class="text-red-500">0</span></div>
                    <div>ä¿ç•™: <span id="stat-kept" class="text-green-600">0</span></div>
                    <div>æ¯”ä¾‹: <span id="stat-ratio" class="text-blue-600">100%</span></div>
                    <div>åˆªé™¤ç‰‡æ®µ: <span id="stat-fragments" class="text-purple-500">0</span></div>
                </div>
            </div>

            <!-- å¿«é€Ÿè¼¸å…¥å·¥å…· (æˆªåœ–æ™‚éš±è—) -->
            <div id="quick-toolbar" class="bg-white p-3 border-b-2 border-indigo-100 flex flex-wrap items-center gap-4 justify-center">
                <div class="flex items-center gap-2 text-indigo-700 font-bold shrink-0">
                    <i data-lucide="rocket"></i> å¿«é€Ÿè¼¸å…¥å·¥å…·
                </div>
                <div class="flex flex-wrap items-center gap-x-4 gap-y-2" id="toolbar-buttons">
                    <!-- Buttons generated by JS -->
                </div>
            </div>

            <!-- ä¸»è¦æ“ä½œå€ (Grid) -->
            <div id="workspace-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-0 divide-x-2 divide-gray-100">
                <!-- å·¦å´ï¼šåˆªé™¤ç·´ç¿’ -->
                <div class="flex flex-col bg-yellow-50/20">
                    <div class="p-3 bg-yellow-50 border-b-2 border-yellow-100 flex justify-between items-center h-14">
                        <h4 class="font-bold text-gray-700 flex items-center gap-2">ğŸ“– åˆªé™¤éç¨‹ <span class="text-xs font-normal text-red-600 bg-white px-2 py-0.5 rounded-full border border-red-100">ç´…å­—+ç²—é«”=åˆªé™¤</span></h4>
                        <div class="flex gap-2">
                            <button onclick="handleDeleteSelection()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs flex items-center gap-1 font-bold shadow-sm transition-all"><i data-lucide="scissors" class="w-3 h-3"></i> åˆªé™¤/å¾©åŸ</button>
                            <button onclick="toggleArticleModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs flex items-center gap-1 font-bold shadow-sm transition-all"><i data-lucide="library" class="w-3 h-3"></i> é¸æ–‡ç« </button>
                        </div>
                    </div>
                    <div id="deletion-area" class="p-6 flex-grow text-lg leading-loose text-gray-800 whitespace-pre-wrap outline-none min-h-[450px]" style="line-height: 2.5rem;" contenteditable="true"></div>
                    
                    <!-- AI Hint (æˆªåœ–æ™‚éš±è—) -->
                    <div id="ai-hint-section" class="p-3 bg-yellow-50 border-t-2 border-yellow-100 min-h-[80px] flex flex-col justify-center items-center">
                        <button id="btn-ask-hint" onclick="askAIHint()" class="w-full bg-white border-2 border-yellow-200 text-yellow-700 py-2 rounded-xl flex items-center justify-center gap-2 hover:bg-yellow-50 transition-colors font-bold shadow-sm active:scale-95">
                            <i data-lucide="lightbulb"></i> ğŸ”‘ æ‰¾ä¸åˆ°é‡é»ï¼Ÿå•å• AI å°åµæ¢
                        </button>
                        <div id="ai-hint-content" class="hidden w-full relative">
                            <button onclick="closeAIHint()" class="absolute top-1 right-1 text-gray-400 hover:text-gray-600 z-10"><i data-lucide="x" class="w-4 h-4"></i></button>
                            <div class="p-4 bg-white rounded-2xl border-2 border-yellow-200 shadow-md">
                                <div class="flex items-center gap-2 mb-2 text-yellow-800 font-bold border-b border-yellow-100 pb-2">
                                    <i data-lucide="sparkles" class="text-yellow-500"></i> AI å°åµæ¢çš„æç¤ºï¼š
                                </div>
                                <div id="ai-hint-text" class="text-lg leading-relaxed text-gray-700 whitespace-pre-wrap"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šæ‘˜è¦æ’°å¯« -->
                <div class="flex flex-col bg-green-50/20">
                    <div class="p-3 bg-green-50 border-b-2 border-green-100 flex justify-between items-center h-14">
                        <h4 class="font-bold text-green-800 flex items-center gap-2">âœ¨ å®Œæˆçš„æ‘˜è¦ <span class="text-xs font-normal text-green-600 bg-white px-2 py-0.5 rounded-full border border-green-100">å¯ç›´æ¥ç·¨è¼¯</span></h4>
                        <div class="text-xs text-indigo-400 flex items-center gap-1"><i data-lucide="rocket" class="w-3 h-3"></i> ä¸Šæ–¹å¯å¿«é€Ÿè¼¸å…¥</div>
                    </div>
                    <div id="summary-area" class="p-6 flex-grow text-lg leading-loose text-gray-800 whitespace-pre-wrap outline-none min-h-[450px]" style="line-height: 2.5rem;" contenteditable="true"></div>

                    <!-- AI Feedback (æˆªåœ–æ™‚éš±è—) -->
                    <div id="ai-feedback-section" class="p-3 bg-green-50 border-t-2 border-green-100 min-h-[80px] flex flex-col justify-center items-center">
                        <button id="btn-ask-feedback" onclick="askAIFeedback()" class="w-full bg-white border-2 border-green-200 text-green-700 py-2 rounded-xl flex items-center justify-center gap-2 hover:bg-green-50 transition-colors font-bold shadow-sm active:scale-95">
                            <i data-lucide="message-circle"></i> ğŸ‘©â€ğŸ« å¯«å¥½äº†ï¼Ÿè«‹ AI è€å¸«çœ‹ä¸€ä¸‹
                        </button>
                        <div id="ai-feedback-content" class="hidden w-full relative">
                            <button onclick="closeAIFeedback()" class="absolute top-1 right-1 text-gray-400 hover:text-gray-600 z-10"><i data-lucide="x" class="w-4 h-4"></i></button>
                            <div class="p-4 bg-white rounded-2xl border-2 border-green-200 shadow-md">
                                <div class="flex items-center gap-2 mb-2 text-green-800 font-bold border-b border-green-100 pb-2">
                                    <i data-lucide="sparkles" class="text-green-500"></i> AI è€å¸«çš„å°è©•èªï¼š
                                </div>
                                <div id="ai-feedback-text" class="text-lg leading-relaxed text-gray-700 whitespace-pre-wrap"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- è‡ªæˆ‘æª¢æ ¸èˆ‡æäº¤ -->
        <section class="bg-white rounded-3xl p-8 shadow-sm border border-indigo-50">
            <div class="flex items-center gap-3 mb-8">
                <span class="text-3xl bg-indigo-100 p-2 rounded-xl">ğŸ”</span>
                <h2 class="text-2xl font-bold text-indigo-900">æäº¤å‰è‡ªæˆ‘æª¢æ ¸</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="grid grid-cols-1 gap-4" id="checklist-container">
                    <!-- Checkboxes rendered by JS -->
                </div>

                <div class="flex flex-col gap-6">
                    <div class="bg-indigo-50 p-6 rounded-3xl border-2 border-indigo-100 shadow-sm">
                        <h3 class="text-xl font-bold text-indigo-800 mb-4 flex items-center gap-2"><i data-lucide="user"></i> å­¸ç”Ÿè³‡è¨Š</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-indigo-600 text-sm font-bold mb-1 ml-1">ä½ çš„åå­—</label>
                                <input type="text" id="input-name" class="w-full p-4 rounded-xl border-2 border-indigo-200 focus:border-indigo-500 outline-none text-lg bg-white" placeholder="è¼¸å…¥å§“å" oninput="updateStudentInfo()">
                            </div>
                            <div>
                                <label class="block text-indigo-600 text-sm font-bold mb-1 ml-1">ä½ çš„åº§è™Ÿ</label>
                                <input type="text" id="input-seat" class="w-full p-4 rounded-xl border-2 border-indigo-200 focus:border-indigo-500 outline-none text-lg bg-white" placeholder="è¼¸å…¥åº§è™Ÿ" oninput="updateStudentInfo()">
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-6 rounded-3xl border-2 border-yellow-200 flex-grow shadow-sm flex flex-col justify-center">
                        <h3 class="text-xl font-bold text-yellow-800 mb-4 flex items-center gap-2"><i data-lucide="thumbs-up"></i> ä¿¡å¿ƒè©•ä¼°</h3>
                        <p class="font-bold text-yellow-700 mb-4 text-lg">å®Œæˆé€™æ¬¡ç·´ç¿’ï¼Œä½ è¦ºå¾—è‡ªå·±è¡¨ç¾å¾—å¦‚ä½•ï¼Ÿ</p>
                        <div class="grid grid-cols-3 gap-3 h-full" id="confidence-container">
                            <!-- Buttons rendered by JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-12 flex justify-center">
                <button onclick="handleSubmit()" class="group relative bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-2xl font-bold py-5 px-20 rounded-full shadow-xl hover:shadow-2xl hover:scale-105 transform transition-all flex items-center gap-4 overflow-hidden">
                    <div class="absolute inset-0 bg-white/20 group-hover:translate-x-full transition-transform duration-700 skew-x-12 -translate-x-full"></div>
                    <i data-lucide="save" class="w-8 h-8"></i>
                    <span>æäº¤ä½œæ¥­</span>
                </button>
            </div>
        </section>
    </main>

    <!-- Article Modal -->
    <div id="article-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div class="flex items-center gap-3"><span class="bg-indigo-100 text-indigo-700 p-2 rounded-lg"><i data-lucide="library"></i></span><h3 class="text-2xl font-bold text-gray-800">é¸æ“‡ç·´ç¿’æ–‡ç« </h3></div>
                <button onclick="toggleArticleModal()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto space-y-4 px-2" id="article-list">
                <!-- Articles rendered by JS -->
            </div>
        </div>
    </div>

    <!-- Teacher Modal -->
    <div id="teacher-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="user"></i> æ•™å¸«å°ˆå€</h3>
                <button onclick="toggleTeacherModal()" class="text-gray-500 hover:text-gray-800">âœ•</button>
            </div>
            <div id="teacher-login" class="flex flex-col items-center justify-center py-10">
                <p class="mb-4 text-gray-600 font-bold">è«‹è¼¸å…¥æ•™å¸«å¯†ç¢¼ (é è¨­: 1234)</p>
                <input type="password" id="teacher-password" class="border-2 border-gray-300 p-3 rounded-xl mb-4 w-48 text-center text-xl outline-none focus:border-indigo-500" />
                <button onclick="teacherLogin()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors">ç™»å…¥</button>
            </div>
            <div id="teacher-dashboard" class="hidden flex-col h-full overflow-hidden">
                <!-- Tabs -->
                <div class="flex gap-4 mb-4 border-b items-center justify-between">
                    <div class="flex gap-4">
                        <button onclick="switchTeacherTab('submissions')" id="tab-submissions" class="pb-2 px-4 font-bold text-lg transition-colors border-b-2 text-indigo-600 border-indigo-600">å­¸ç”Ÿä½œæ¥­</button>
                        <button onclick="switchTeacherTab('articles')" id="tab-articles" class="pb-2 px-4 font-bold text-lg transition-colors border-b-2 text-gray-400 border-transparent hover:text-gray-600">æ–‡ç« ç®¡ç†</button>
                    </div>
                    <div id="sort-controls" class="flex items-center gap-2 text-sm text-gray-600 bg-gray-100 px-3 py-1.5 rounded-lg">
                        <i data-lucide="arrow-up-down" class="w-4 h-4"></i>
                        <span class="font-bold">æ’åºï¼š</span>
                        <select id="sort-select" onchange="renderSubmissions()" class="bg-transparent outline-none font-bold text-indigo-700 cursor-pointer">
                            <option value="time">æäº¤æ™‚é–“ (æ–°â†’èˆŠ)</option>
                            <option value="seat">åº§è™Ÿ (å°â†’å¤§)</option>
                        </select>
                    </div>
                </div>
                <!-- Submissions View -->
                <div id="view-submissions" class="flex-col h-full overflow-hidden flex">
                    <div class="mb-4 flex gap-2">
                        <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-700 shadow-sm"><i data-lucide="download" class="w-4 h-4"></i> åŒ¯å‡º CSV</button>
                        <div class="text-sm text-gray-500 self-center ml-auto bg-gray-100 px-3 py-1 rounded-full">å…± <span id="submission-count">0</span> ç­†è³‡æ–™</div>
                    </div>
                    <div class="flex-grow overflow-auto border rounded-xl bg-gray-50">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-100 sticky top-0 shadow-sm">
                                <tr>
                                    <th class="p-3 text-gray-600">æ™‚é–“</th>
                                    <th class="p-3 text-gray-600">å§“å</th>
                                    <th class="p-3 text-gray-600">åº§è™Ÿ</th>
                                    <th class="p-3 text-gray-600">å­—æ•¸ (åŸ/æ‘˜)</th>
                                    <th class="p-3 text-gray-600 bg-blue-50 text-blue-700 font-bold border-l border-blue-100">ä¿ç•™æ¯”ä¾‹</th>
                                    <th class="p-3 text-gray-600 bg-red-50 text-red-700 font-bold border-l border-red-100">åˆªé™¤ç‰‡æ®µ</th>
                                    <th class="p-3 text-gray-600">è‡ªæˆ‘ä¿¡å¿ƒ</th>
                                </tr>
                            </thead>
                            <tbody id="submissions-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Articles View -->
                <div id="view-articles" class="hidden flex-col h-full gap-4">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                        <h4 class="font-bold text-indigo-800 mb-3 flex items-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i> æ–°å¢ç·´ç¿’æ–‡ç« </h4>
                        <div class="flex flex-col gap-3">
                            <input type="text" id="new-article-title" placeholder="æ–‡ç« æ¨™é¡Œ" class="p-2 rounded-lg border border-indigo-200 focus:border-indigo-500 outline-none" />
                            <textarea id="new-article-content" placeholder="è²¼ä¸Šæ–‡ç« å…§å®¹..." class="p-2 rounded-lg border border-indigo-200 focus:border-indigo-500 outline-none h-24 resize-none"></textarea>
                            <button onclick="addArticle()" class="bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition-colors self-end px-6">æ–°å¢æ–‡ç« </button>
                        </div>
                    </div>
                    <div class="flex-grow overflow-auto border rounded-xl bg-white">
                        <div class="bg-gray-100 p-3 font-bold text-gray-600 sticky top-0 border-b">å·²å»ºç«‹çš„æ–‡ç« åº«</div>
                        <div id="articles-manage-list" class="divide-y"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        

        // --- å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š ---
        const DEFAULT_ARTICLE = `ã€€ã€€ç¾å¦‚å¥¶å¥¶å€‹å­ä¸é«˜ï¼Œæœ‰è‘—åœ“åœ“çš„è‡‰è›‹ã€ä¸€é ­ç°ç™½çš„çŸ­é«®ã€‚å¥¹å¸¸å¸¸ç©¿è‘—ä¸€ä»¶è—è‰²çš„å·¥ä½œåœè£™ï¼Œæˆ´è‘—ä¸€å‰¯ç´«è‰²çš„çœ¼é¡ï¼Œæ»¿è‡‰ç¬‘å®¹ï¼Œçœ‹èµ·ä¾†ç‰¹åˆ¥æœ‰æ´»åŠ›ã€‚
ã€€ã€€æ”¾å­¸å¾Œï¼Œæˆ‘å€‘æœ€å–œæ­¡åˆ°ã€Œå°æ›¸åº—ã€äº†ï¼ç¾å¦‚å¥¶å¥¶åœ¨åº—è£¡å¾ˆå¿™ï¼Œå¥¹æœ‰æ™‚æœƒæŠŠæ›¸æ¶ä¸Šçš„æ›¸ä¸€æœ¬æœ¬æ’å¥½ï¼Œæœ‰æ™‚æœƒä»”ç´°æ”¶æ‹¾æ–‡å…·å€æ•£è½çš„æ±è¥¿ã€‚æˆ‘å€‘å–œæ­¡åœ¨æ›¸åº—è£¡çœ‹æ›¸ï¼Œæœ‰æ™‚çœ‹è‘—çœ‹è‘—ï¼Œå¿ä¸ä½å¤§è²è¨è«–èµ·ä¾†ï¼Œåƒåµé¬§çš„å°éº»é›€ã€‚é€™æ™‚å€™ç¾å¦‚å¥¶å¥¶æœƒé éä¾†ï¼Œå°æˆ‘å€‘å¾®å¾®ç¬‘ï¼Œæ¯”å‡ºä¸€å€‹ã€Œè«‹å®‰éœã€çš„é­”æ³•æš—è™Ÿã€‚
ã€€ã€€æ›¸åº—é›–ç„¶å¾ˆå°ï¼Œä¸éæ±è¥¿ä¸å°‘ï¼Œç¾å¦‚å¥¶å¥¶çš„è…¦å­è£¡å¥½åƒæœ‰éƒ¨é›»è…¦ï¼Œç¸½æ˜¯çŸ¥é“ä»€éº¼æ±è¥¿æ”¾åœ¨å“ªè£¡ã€‚å‡å¦‚æœ‰äººå•ï¼šã€Œæˆ‘å€‘è¦åšç§‘å±•ï¼Œè©²çœ‹ä»€éº¼æ›¸å‘¢ï¼Ÿã€ä¸€æœ¬ä¹åä¹å€‹å¥½ç©çš„ç§‘å­¸éŠæˆ²å°±æœƒäº¤åˆ°ä»–æ‰‹ä¸Šã€‚å‡å¦‚æœ‰äººå•ï¼šã€Œæœ‰æ²’æœ‰æ•™äººæ€éº¼è®Šé­”è¡“çš„æ›¸ï¼Ÿã€å¥¹æœƒå¹«å¿™æ‰¾å‡ºä¸€æœ¬å°å°é­”è¡“å¸«ã€‚å‡å¦‚æœ‰äººè¦è²·æ°´å½©ç­†ã€ç­†è¨˜æœ¬ã€å¡ç´™â€¦â€¦å¥¹éƒ½èƒ½å¾ˆå¿«çš„å¹«åŠ©å¤§å®¶æ‰¾å‡ºä¾†ã€‚
ã€€ã€€æ›¸åº—ä¸å¿™çš„æ™‚å€™ï¼Œç¾å¦‚å¥¶å¥¶æœƒååœ¨ä¸€å¼µç‰¹è£½çš„é«˜è…³æ¤…ä¸Šå°ˆå¿ƒçœ‹æ›¸ã€‚æ›¸åº—è£¡æœ‰å¼µå°å°çš„æ¨™èªå¯«è‘—ï¼šã€Œå¤©åº•ä¸‹æœ€æ£’çš„äº‹æƒ…ï¼Œå°±æ˜¯è·Ÿæ›¸æœ¬æˆç‚ºæœ‹å‹ã€‚ã€å¸¸åˆ°æ›¸åº—çš„æˆ‘å€‘ï¼Œå› ç‚ºç¾å¦‚å¥¶å¥¶ï¼Œä¹Ÿè·Ÿæ›¸æœ¬è®Šæˆå¥½æœ‹å‹ï¼Œæˆç‚ºçœŸæ­£çš„æ„›æ›¸äººã€‚`;

        const PRONOUNS = ['æˆ‘', 'ä½ ', 'ä»–', 'å¥¹', 'å®ƒ', 'æˆ‘å€‘', 'ä½ å€‘', 'ä»–å€‘'];
        const PUNCTUATIONS = ['ã€', 'ï¼Œ', 'ã€‚', 'ï¼', 'ï¼Ÿ', 'ï¼š', 'ã€Œ', 'ã€'];
        const CONJUNCTIONS = ['é¦–å…ˆ', 'ç„¶å¾Œ', 'æ¥è‘—', 'æœ€å¾Œ', 'å› ç‚º', 'æ‰€ä»¥', 'ä½†æ˜¯', 'å¯æ˜¯', 'è€Œä¸”', 'ä¸é', 'å¦å¤–', 'ç¸½ä¹‹'];
        
        const HINTS = {
            q1: ["ğŸ¤” å¦‚æœä¸æ‡‚ï¼Œè©¦è‘—é‡æ–°è®€ä¸€éé€™æ®µï¼Œæ‰¾å‡ºé—œéµè©ï¼", "âœ¨ ç†è§£æ˜¯æ‘˜è¦çš„ç¬¬ä¸€æ­¥ï¼Œæ…¢æ…¢ä¾†æ²’é—œä¿‚ï¼"],
            q2: ["ğŸ¯ é‡é»é€šå¸¸åœ¨æ®µè½çš„é–‹é ­æˆ–çµå°¾ï¼", "âœ¨ é‡é»é€šå¸¸æ˜¯åœ¨èªªã€Œèª°åšäº†ä»€éº¼ã€æˆ–ã€Œä»€éº¼æ˜¯ä»€éº¼ã€"],
            q3: ["ğŸ—‘ï¸ å…·é«”çš„æ•¸å­—ã€æ™‚é–“ã€åœ°é»ç´°ç¯€å¯ä»¥è€ƒæ…®åˆªé™¤", "âœ‚ï¸ å½¢å®¹è©ã€å‰¯è©é€šå¸¸å¯ä»¥åˆªé™¤"]
        };

        const apiKey = "AIzaSyDEvWbTOt6oh1ZsCLR-emsHemQSFYk2E4w";
        const teacherApiKey = ""; 

        let user = null;
        let db = null;
        let appId = 'default-app-id';
        let originalText = DEFAULT_ARTICLE;
        let currentSubmissions = [];
        let currentArticles = [];
        let stats = { originalLength: 0, deletedChars: 0, keptChars: 0, ratio: 100, deletionFragments: 0 };
        let studentInfo = { name: '', seatNumber: '' };
        let checks = { check1: null, check2: null, check3: null, check4: null, confidence: null };
        let hintIndices = { q1: 0, q2: 0, q3: 0 };

        // --- åˆå§‹åŒ– Firebase ---
        function initFirebase() {
            try {
                let config;
                if (typeof __firebase_config !== 'undefined') {
                    config = JSON.parse(__firebase_config);
                    // ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨ __app_id å³å¯ï¼Œä¸é€²è¡Œ sanitize
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                } else {
                    console.warn("No firebase config found. App running in offline mode.");
                    return;
                }

                const app = initializeApp(config);
                const auth = getAuth(app);
                db = getFirestore(app);

                // æ¨™æº–çš„ Canvas é©—è­‰æµç¨‹ï¼šå„ªå…ˆä½¿ç”¨ Custom Token
                const doAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Auth failed:", e);
                    }
                };
                
                doAuth();

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if(user) {
                        loadArticles();
                        if(document.getElementById('teacher-dashboard').style.display === 'flex') {
                            loadSubmissions();
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase init error:", e);
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---

        // åˆªé™¤/å¾©åŸåŠŸèƒ½
        window.handleDeleteSelection = function() {
            const sel = window.getSelection();
            if(!sel.rangeCount) return;

            let node = sel.anchorNode;
            if(node.nodeType === 3) node = node.parentNode;

            if(node.classList.contains('deletion-text')) {
                const text = node.innerText;
                node.replaceWith(text);
                updateStats();
                return;
            }

            const range = sel.getRangeAt(0);
            const container = document.getElementById('deletion-area');
            if(!container.contains(range.commonAncestorContainer)) return;
            if(range.toString().length === 0) return;

            const span = document.createElement('span');
            span.className = "deletion-text"; 
            span.title = "é»æ“Šä»¥å¾©åŸ";
            
            try {
                range.surroundContents(span);
                sel.removeAllRanges();
                updateStats();
            } catch(e) {
                alert("è«‹é¸å–å®Œæ•´çš„æ–‡å­—ç‰‡æ®µï¼Œä¸è¦è·¨è¶Šå¤šå€‹æ®µè½å–”ï¼");
            }
        }

        document.getElementById('deletion-area').addEventListener('click', (e) => {
            if(e.target.classList.contains('deletion-text')) {
                const text = e.target.innerText;
                const textNode = document.createTextNode(text);
                e.target.parentNode.replaceChild(textNode, e.target);
                updateStats();
            }
        });

        function updateStats() {
            const container = document.getElementById('deletion-area');
            const deletedNodes = container.querySelectorAll('.deletion-text');
            
            let deletedLen = 0;
            deletedNodes.forEach(node => deletedLen += node.innerText.length);
            
            const origLen = originalText.length;
            const kept = Math.max(0, origLen - deletedLen);
            const ratio = origLen > 0 ? Math.round((kept / origLen) * 100) : 0;

            stats = {
                originalLength: origLen,
                deletedChars: deletedLen,
                keptChars: kept,
                ratio: ratio,
                deletionFragments: deletedNodes.length
            };

            document.getElementById('stat-original').innerText = stats.originalLength;
            document.getElementById('stat-deleted').innerText = stats.deletedChars;
            document.getElementById('stat-kept').innerText = stats.keptChars;
            document.getElementById('stat-ratio').innerText = stats.ratio + '%';
            document.getElementById('stat-fragments').innerText = stats.deletionFragments;
        }

        window.insertText = function(text) {
            const div = document.getElementById('summary-area');
            div.focus();
            document.execCommand('insertText', false, text);
        }

        function initToolbar() {
            const container = document.getElementById('toolbar-buttons');
            const createGroup = (items, colorClass, title) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-1";
                div.innerHTML = `<span class="text-[10px] font-bold ${colorClass} px-1.5 py-0.5 rounded">${title}</span>`;
                items.forEach(t => {
                    const btn = document.createElement('button');
                    btn.innerText = t;
                    let btnClass = "";
                    if(colorClass.includes("purple")) btnClass = "bg-purple-50 text-purple-700 border-purple-200 hover:bg-purple-100";
                    else if(colorClass.includes("blue")) btnClass = "bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100";
                    else btnClass = "bg-green-50 text-green-700 border-green-200 hover:bg-green-100";
                    
                    btn.className = `${btnClass} border px-2 py-1 rounded-lg text-sm font-bold active:scale-95 transition-all`;
                    btn.onclick = () => insertText(t);
                    div.appendChild(btn);
                });
                return div;
            };
            container.appendChild(createGroup(PRONOUNS, "text-purple-600 bg-purple-100", "ä»£åè©"));
            container.appendChild(createGroup(PUNCTUATIONS, "text-blue-600 bg-blue-100", "æ¨™é»"));
            container.appendChild(createGroup(CONJUNCTIONS, "text-green-600 bg-green-100", "é€£æ¥è©"));
        }

        // --- AI åŠŸèƒ½ ---
        async function callAI(prompt) {
            const key = teacherApiKey || apiKey;
            if(!key) {
                return "âš ï¸ ç³»çµ±æœªåµæ¸¬åˆ° API é‡‘é‘°ï¼Œè«‹ç¢ºèªç’°å¢ƒè¨­å®šã€‚";
            }

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    }
                );
                if(!response.ok) return "âš ï¸ AI é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch(e) {
                console.error("AI Error:", e);
                return "âš ï¸ ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•é€£æ¥ AI æœå‹™ã€‚";
            }
        }

        window.askAIHint = async function() {
            const btn = document.getElementById('btn-ask-hint');
            const contentDiv = document.getElementById('ai-hint-content');
            const textDiv = document.getElementById('ai-hint-text');
            
            btn.innerHTML = `<span class="animate-spin">ğŸ”„</span> AI æ­£åœ¨æ€è€ƒ...`;
            
            const prompt = `ä½ æ˜¯åœ‹å°ä¸‰å¹´ç´šå­¸ç”Ÿçš„é–±è®€å°å¹«æ‰‹ã€‚é€™ç¯‡æ–‡ç« å…§å®¹æ˜¯ï¼šã€Œ${originalText}ã€ã€‚è«‹æ‰¾å‡ºæœ€é‡è¦çš„3å€‹é—œéµé‡é»ï¼Œç”¨æ¢åˆ—å¼ï¼Œç°¡å–®èªæ°£ï¼Œç¸½å­—æ•¸60å­—ä»¥å…§ã€‚`;
            const result = await callAI(prompt);
            
            btn.innerHTML = `<i data-lucide="lightbulb"></i> ğŸ”‘ æ‰¾ä¸åˆ°é‡é»ï¼Ÿå•å• AI å°åµæ¢`;
            
            btn.style.display = 'none';
            contentDiv.classList.remove('hidden');
            typewriter(textDiv, result || "âš ï¸ AI ç„¡æ³•å›æ‡‰");
        }

        window.closeAIHint = function() {
            document.getElementById('ai-hint-content').classList.add('hidden');
            document.getElementById('btn-ask-hint').style.display = 'flex';
        }

        window.askAIFeedback = async function() {
            const summary = document.getElementById('summary-area').innerText;
            if(summary.length < 10) { alert("è«‹å…ˆå¯«å¤šä¸€é»å…§å®¹å–”ï¼"); return; }

            const btn = document.getElementById('btn-ask-feedback');
            const contentDiv = document.getElementById('ai-feedback-content');
            const textDiv = document.getElementById('ai-feedback-text');

            btn.innerHTML = `<span class="animate-spin">ğŸ”„</span> AI æ­£åœ¨æ”¹ä½œæ¥­...`;

            const prompt = `ä½ æ˜¯æº«æŸ”çš„åœ‹å°è€å¸«ã€‚å­¸ç”Ÿæ‘˜è¦ï¼šã€Œ${summary}ã€ã€‚åŸæ–‡ï¼šã€Œ${originalText}ã€ã€‚è«‹çµ¦äºˆè©•åˆ†(æ»¿åˆ†100)èˆ‡3é»å…·é«”å»ºè­°(é‡é»ã€ç°¡æ½”ã€æµæš¢)ï¼Œèªæ°£é¼“å‹µã€‚`;
            const result = await callAI(prompt);

            btn.innerHTML = `<i data-lucide="message-circle"></i> ğŸ‘©â€ğŸ« å¯«å¥½äº†ï¼Ÿè«‹ AI è€å¸«çœ‹ä¸€ä¸‹`;

            btn.style.display = 'none';
            contentDiv.classList.remove('hidden');
            typewriter(textDiv, result || "âš ï¸ AI ç„¡æ³•å›æ‡‰");
        }

        window.closeAIFeedback = function() {
            document.getElementById('ai-feedback-content').classList.add('hidden');
            document.getElementById('btn-ask-feedback').style.display = 'flex';
        }

        function typewriter(element, text) {
            element.innerText = "";
            let i = 0;
            const timer = setInterval(() => {
                if(i < text.length) {
                    element.innerText += text.charAt(i);
                    i++;
                } else clearInterval(timer);
            }, 20);
        }

        // --- æç¤ºå¡åŠŸèƒ½ ---
        window.showHint = function(id) {
            const list = HINTS[id];
            const idx = hintIndices[id];
            document.getElementById('hint-display').innerText = list[idx];
            hintIndices[id] = (idx + 1) % list.length;
        }

        // --- è‡ªæˆ‘æª¢æ ¸èˆ‡è³‡è¨Š ---
        function initChecklist() {
            const container = document.getElementById('checklist-container');
            const questions = [
                {id: 'check1', text: 'æˆ‘å¯«çš„æ‘˜è¦æœ‰æŠŠé‡é»èªªæ¸…æ¥šå—ï¼Ÿ', icon: 'book-open', color: 'orange'},
                {id: 'check2', text: 'é‚„æœ‰å“ªè£¡çœ‹ä¸æ‡‚å—ï¼Ÿ', icon: 'help-circle', color: 'purple'},
                {id: 'check3', text: 'åˆªæ‰çš„éƒ½æ˜¯ä¸é‡è¦çš„å—ï¼Ÿ', icon: 'trash-2', color: 'red'},
                {id: 'check4', text: 'å¥å­è®€èµ·ä¾†é€šé †å—ï¼Ÿ', icon: 'pen-tool', color: 'cyan'}
            ];

            questions.forEach(q => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl border-2 bg-white border-dashed border-gray-300 transition-all`;
                div.innerHTML = `
                    <div class="flex items-start gap-3 mb-2">
                        <div class="p-1 rounded-full bg-gray-100 text-gray-400"><i data-lucide="${q.icon}"></i></div>
                        <p class="font-bold text-gray-800">${q.text}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateCheck('${q.id}', true, this)" class="flex-1 py-2 rounded-lg border text-sm font-bold hover:bg-gray-50">æ˜¯</button>
                        <button onclick="updateCheck('${q.id}', false, this)" class="flex-1 py-2 rounded-lg border text-sm font-bold hover:bg-gray-50">å¦</button>
                    </div>
                `;
                container.appendChild(div);
            });

            // ä¿¡å¿ƒæŒ‰éˆ•
            const confContainer = document.getElementById('confidence-container');
            const confs = [
                {val: 'good', text: 'æˆ‘è¦ºå¾—å¾ˆå¥½ï¼', emoji: 'ğŸ˜„'},
                {val: 'ok', text: 'æˆ‘è¦ºå¾—é‚„å¯ä»¥', emoji: 'ğŸ™‚'},
                {val: 'unsure', text: 'æˆ‘ä¸å¤ªç¢ºå®š', emoji: 'ğŸ¤”'}
            ];
            confs.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "rounded-2xl font-bold text-sm border-b-4 bg-white border-yellow-200 text-yellow-600 hover:bg-yellow-100 flex flex-col items-center justify-center p-2 transition-all active:scale-95";
                btn.innerHTML = `<span class="text-2xl">${c.emoji}</span><span>${c.text}</span>`;
                btn.onclick = () => {
                    checks.confidence = c.val;
                    // Reset style
                    Array.from(confContainer.children).forEach(b => b.className = b.className.replace('bg-yellow-400 border-yellow-600 text-white', 'bg-white border-yellow-200 text-yellow-600'));
                    // Set active
                    btn.className = btn.className.replace('bg-white border-yellow-200 text-yellow-600', 'bg-yellow-400 border-yellow-600 text-white');
                    updateStudentInfo();
                };
                confContainer.appendChild(btn);
            });
        }

        window.updateCheck = function(id, val, btn) {
            checks[id] = val;
            const parent = btn.parentNode;
            const card = parent.parentNode;
            // Visual update
            const color = id === 'check1' ? 'orange' : id === 'check3' ? 'red' : id === 'check4' ? 'cyan' : 'purple';
            
            if(val) {
                card.className = `p-4 rounded-2xl border-2 bg-${color}-50 border-${color}-400 shadow-md transition-all`;
                // Reset buttons
                Array.from(parent.children).forEach(b => b.className = "flex-1 py-2 rounded-lg border text-sm font-bold bg-white text-gray-500");
                btn.className = `flex-1 py-2 rounded-lg text-sm font-bold bg-${color}-500 text-white shadow`;
            } else {
                card.className = `p-4 rounded-2xl border-2 bg-gray-50 border-gray-200 transition-all`;
                Array.from(parent.children).forEach(b => b.className = "flex-1 py-2 rounded-lg border text-sm font-bold bg-white text-gray-500");
                btn.className = "flex-1 py-2 rounded-lg text-sm font-bold bg-gray-500 text-white shadow";
            }
        }

        window.updateStudentInfo = function() {
            studentInfo.name = document.getElementById('input-name').value;
            studentInfo.seatNumber = document.getElementById('input-seat').value;
            
            document.getElementById('display-student-name').innerText = `${studentInfo.name || 'å­¸ç”Ÿå§“å'} (åº§è™Ÿ: ${studentInfo.seatNumber || '?'})`;
            
            const map = { good: 'æˆ‘è¦ºå¾—å¾ˆå¥½ï¼', ok: 'æˆ‘è¦ºå¾—é‚„å¯ä»¥', unsure: 'æˆ‘ä¸å¤ªç¢ºå®š' };
            document.getElementById('display-confidence').innerText = map[checks.confidence] || 'å°šæœªè©•ä¼°';
        }

        // --- æˆªåœ–åŠŸèƒ½ ---
        window.handleDownloadSnapshot = async function() {
            const el = document.getElementById('workspace-card');
            const btn = document.getElementById('btn-snapshot');
            btn.innerText = "è™•ç†ä¸­...";
            
            try {
                const canvas = await html2canvas(el, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    windowWidth: 1280, // å¼·åˆ¶é›»è…¦ç‰ˆå¯¬åº¦
                    onclone: (doc) => {
                        // å¼·åˆ¶ Grid ä½ˆå±€
                        const grid = doc.getElementById('workspace-grid');
                        grid.style.display = 'grid';
                        grid.style.gridTemplateColumns = '1fr 1fr';
                        grid.classList.remove('grid-cols-1', 'lg:grid-cols-2');

                        // éš±è—å·¥å…·åˆ—èˆ‡ AI
                        doc.getElementById('quick-toolbar').style.display = 'none';
                        doc.getElementById('ai-hint-section').style.display = 'none';
                        doc.getElementById('ai-feedback-section').style.display = 'none';
                        doc.getElementById('btn-snapshot').style.display = 'none'; // éš±è—ä¸‹è¼‰æŒ‰éˆ•è‡ªå·±

                        // å±•é–‹æ–‡å­—å€
                        const expand = (id) => {
                            const d = doc.getElementById(id);
                            d.style.height = 'auto';
                            d.style.overflow = 'visible';
                        };
                        expand('deletion-area');
                        expand('summary-area');
                    }
                });
                
                const link = document.createElement('a');
                link.download = `${studentInfo.name || 'ä½œæ¥­'}_æ‘˜è¦.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch(e) {
                console.error(e);
                alert("æˆªåœ–å¤±æ•—");
            } finally {
                btn.innerHTML = `<i data-lucide="download" class="w-4 h-4"></i> ä¸‹è¼‰æˆªåœ–`;
                lucide.createIcons();
            }
        }

        // --- æäº¤èˆ‡è³‡æ–™åº« ---
        window.handleSubmit = async function() {
            if(!db || !user) { alert("è³‡æ–™åº«æœªé€£ç·š"); return; }
            if(!studentInfo.name) { alert("è«‹å¡«å¯«å§“å"); return; }
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'student_summaries'), {
                    userId: user.uid,
                    studentInfo,
                    originalText,
                    deletionHtml: document.getElementById('deletion-area').innerHTML,
                    finalSummary: document.getElementById('summary-area').innerText,
                    checks,
                    stats,
                    createdAt: serverTimestamp()
                });
                alert("ä½œæ¥­æäº¤æˆåŠŸï¼");
            } catch(e) {
                console.error(e);
                alert("æäº¤å¤±æ•—");
            }
        }

        // --- æ–‡ç« ç®¡ç† ---
        window.toggleArticleModal = function() {
            const modal = document.getElementById('article-modal');
            modal.classList.toggle('hidden');
        }

        function loadArticles() {
            if(!db) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'articles'));
            onSnapshot(q, (snapshot) => {
                currentArticles = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderArticleList();
            }, (error) => {
                console.error("Error loading articles:", error);
            });
        }

        function renderArticleList() {
            const list = document.getElementById('article-list');
            list.innerHTML = '';
            
            // é è¨­æ–‡ç« 
            const defaultDiv = document.createElement('div');
            defaultDiv.className = "bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-xl border border-indigo-100 cursor-pointer hover:shadow-md";
            defaultDiv.innerHTML = `<h4 class="font-bold text-indigo-800">ğŸ° é‡è¦‹ç¾å¦‚å¥¶å¥¶ (é è¨­)</h4><p class="text-sm text-gray-600 line-clamp-2">${DEFAULT_ARTICLE}</p>`;
            defaultDiv.onclick = () => selectArticle(DEFAULT_ARTICLE);
            list.appendChild(defaultDiv);

            // è‡ªè¨‚æ–‡ç« 
            const customDiv = document.createElement('div');
            customDiv.className = "bg-gray-50 border-2 border-dashed border-gray-300 p-4 rounded-xl text-center cursor-pointer hover:bg-gray-100";
            customDiv.innerHTML = `<span class="font-bold text-gray-500"><i data-lucide="pen-tool"></i> è²¼ä¸Šè‡ªå·±çš„æ–‡ç« </span>`;
            customDiv.onclick = () => {
                const text = prompt("è«‹è²¼ä¸Šæ–‡ç« ï¼š");
                if(text) selectArticle(text);
            };
            list.appendChild(customDiv);

            // è³‡æ–™åº«æ–‡ç« 
            currentArticles.forEach(art => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl border hover:border-indigo-300 cursor-pointer hover:shadow-md";
                div.innerHTML = `<h4 class="font-bold">${art.title}</h4><p class="text-sm text-gray-500 line-clamp-2">${art.content}</p>`;
                div.onclick = () => selectArticle(art.content);
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        function selectArticle(text) {
            originalText = text;
            document.getElementById('deletion-area').innerHTML = text;
            document.getElementById('summary-area').innerText = text;
            updateStats();
            toggleArticleModal();
        }

        // --- æ•™å¸«å¾Œå° ---
        window.toggleTeacherModal = function() {
            document.getElementById('teacher-modal').classList.toggle('hidden');
        }

        window.teacherLogin = function() {
            const pwd = document.getElementById('teacher-password').value;
            if(pwd === '1234') {
                document.getElementById('teacher-login').classList.add('hidden');
                document.getElementById('teacher-dashboard').style.display = 'flex';
                loadSubmissions();
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤");
            }
        }

        window.switchTeacherTab = function(tab) {
            const subView = document.getElementById('view-submissions');
            const artView = document.getElementById('view-articles');
            const tabSub = document.getElementById('tab-submissions');
            const tabArt = document.getElementById('tab-articles');
            
            if(tab === 'submissions') {
                subView.classList.remove('hidden');
                subView.classList.add('flex');
                artView.classList.add('hidden');
                artView.classList.remove('flex');
                tabSub.className = tabSub.className.replace('text-gray-400 border-transparent', 'text-indigo-600 border-indigo-600');
                tabArt.className = tabArt.className.replace('text-indigo-600 border-indigo-600', 'text-gray-400 border-transparent');
                document.getElementById('sort-controls').classList.remove('hidden');
            } else {
                subView.classList.add('hidden');
                subView.classList.remove('flex');
                artView.classList.remove('hidden');
                artView.classList.add('flex');
                tabArt.className = tabArt.className.replace('text-gray-400 border-transparent', 'text-indigo-600 border-indigo-600');
                tabSub.className = tabSub.className.replace('text-indigo-600 border-indigo-600', 'text-gray-400 border-transparent');
                document.getElementById('sort-controls').classList.add('hidden');
                renderArticlesManage();
            }
        }

        function loadSubmissions() {
            if(!db) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'student_summaries'));
            onSnapshot(q, (snapshot) => {
                currentSubmissions = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderSubmissions();
            }, (error) => {
                console.error("Error loading submissions:", error);
            });
        }

        window.renderSubmissions = function() {
            const tbody = document.getElementById('submissions-body');
            const sort = document.getElementById('sort-select').value;
            tbody.innerHTML = '';
            
            const sorted = [...currentSubmissions].sort((a, b) => {
                if(sort === 'seat') return (parseInt(a.studentInfo.seatNumber)||999) - (parseInt(b.studentInfo.seatNumber)||999);
                return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
            });

            document.getElementById('submission-count').innerText = sorted.length;

            sorted.forEach(sub => {
                const date = sub.createdAt ? new Date(sub.createdAt.seconds * 1000).toLocaleDateString() : '-';
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white transition-colors";
                tr.innerHTML = `
                    <td class="p-3 text-gray-500">${date}</td>
                    <td class="p-3 font-bold text-gray-800">${sub.studentInfo.name}</td>
                    <td class="p-3 text-gray-800">${sub.studentInfo.seatNumber}</td>
                    <td class="p-3 text-gray-800">${sub.stats.originalLength} / <span class="font-bold text-indigo-600">${sub.stats.summaryLength}</span></td>
                    <td class="p-3 text-blue-700 font-bold bg-blue-50/30 border-l border-blue-50">${sub.stats.ratio}%</td>
                    <td class="p-3 text-red-700 font-bold bg-red-50/30 border-l border-red-50">${sub.stats.deletionFragments}</td>
                    <td class="p-3 text-2xl">${sub.checks.confidence === 'good' ? 'ğŸ˜„' : sub.checks.confidence === 'ok' ? 'ğŸ™‚' : 'ğŸ¤”'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.addArticle = async function() {
            const title = document.getElementById('new-article-title').value;
            const content = document.getElementById('new-article-content').value;
            if(!title || !content) return alert("è«‹è¼¸å…¥å®Œæ•´");
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'articles'), {
                    title, content, createdAt: serverTimestamp()
                });
                alert("æ–°å¢æˆåŠŸ");
                document.getElementById('new-article-title').value = '';
                document.getElementById('new-article-content').value = '';
            } catch(e) { console.error(e); }
        }

        window.deleteArticle = async function(id) {
            if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'articles', id));
            }
        }

        function renderArticlesManage() {
            const list = document.getElementById('articles-manage-list');
            list.innerHTML = '';
            currentArticles.forEach(art => {
                const div = document.createElement('div');
                div.className = "p-4 flex justify-between items-center hover:bg-gray-50";
                div.innerHTML = `
                    <div class="flex-grow pr-4">
                        <div class="font-bold text-lg text-gray-800">${art.title}</div>
                        <div class="text-gray-500 text-sm line-clamp-1">${art.content}</div>
                    </div>
                    <button onclick="deleteArticle('${art.id}')" class="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2"></i></button>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        window.exportToCSV = function() {
            if(!currentSubmissions.length) return;
            const headers = ['å­¸ç”Ÿå§“å', 'åº§è™Ÿ', 'åŸæ–‡å­—æ•¸', 'æ‘˜è¦å­—æ•¸', 'ä¿ç•™æ¯”ä¾‹', 'åˆªé™¤ç‰‡æ®µ', 'è‡ªæˆ‘è©•ä¼°', 'æäº¤æ™‚é–“', 'æ‘˜è¦å…§å®¹'];
            const rows = currentSubmissions.map(sub => [
                sub.studentInfo.name, 
                sub.studentInfo.seatNumber, 
                sub.stats.originalLength, 
                sub.stats.summaryLength, 
                sub.stats.ratio + '%',
                sub.stats.deletionFragments,
                sub.checks.confidence,
                sub.createdAt ? new Date(sub.createdAt.seconds * 1000).toLocaleString('zh-TW') : '', 
                `"${sub.finalSummary.replace(/"/g, '""')}"`
            ]);
            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [headers.join(','), ...rows.map(e => e.join(','))].join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "å­¸ç”Ÿæ‘˜è¦ç·´ç¿’çµ±è¨ˆ.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- å•Ÿå‹• ---
        initFirebase();
        initToolbar();
        selectArticle(DEFAULT_ARTICLE);
        initChecklist();
        lucide.createIcons();

    </script>
</body>
</html>
